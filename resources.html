<link rel="stylesheet" href="resources.css">

<div>
    <button id="settings"       class="topmenu"><img class="menuButton undraggable" src="img/settings.svg"/></button>
    <button id="requirements"   class="topmenu"><img class="menuButton undraggable" src="img/backlog.svg"/></button>
    <button id="schedule"       class="topmenu"><img class="menuButton undraggable" src="img/schedule.svg"/></button>
    <button id="graphs"         class="topmenu"><img class="menuButton undraggable" src="img/graph.svg"/></button>
</div>

<div id="settingsScreen">
    <div id="projectInfo">
        <button id="loadfile" class="inlineButton"><img class="menuButton undraggable" src="img/readfile.svg"/></button>
        <label for="projectName">Projet name:</label>
        <input type="text" id="projectName" name="projectName">
        <label for="startDate" style="margin-left: 20px;">Staring Monday:</label>
        <input type="date" id="startDate" class="monday" name="startDate">
        <button id="savefile" class="inlineButton"><img class="menuButton undraggable" src="img/savefile.svg"/></button>
    </div>

    <div id="teamDiv">
        <div id="people" class="projectComponent">
            <div class="item">
                <img id="developer" class="menuicon person" src="img/developer.svg"/>
            </div>
            <div class="item">
                <img id="lead" class="menuicon person" src="img/lead.svg"/>
            </div>
            <div class="item">
                <img id="tester" class="menuicon person" src="img/tester.svg"/>
            </div>
        </div>
        <div id="team" class="dropzone droplist people"></div>
    </div>

    <div id="scheduleDiv">
        <div class="leftDiv">
            <div id="msTypes" class="projectComponent">
                <div class="item">
                    <img id="development" class="menuicon milestone" src="img/devsprint.svg"/>
                </div>
                <div class="item">
                    <img id="testing" class="menuicon milestone" src="img/qasprint.svg"/>
                </div>
            </div>
            <div id="milestones" class="dropzone droplist schedule"></div>
        </div>

        <div class="rightDiv">
            <div id="blackouts" class="projectComponent">
                <div class="item">
                    <img id="blackoutImg" class="menuicon blackout" src="img/blackout.svg"/>
                </div>
            </div>
            <div id="holidayWeeks" class="dropzone droplist holidayWeeks"></div>
        </div>
    </div>

    <div id="defaultsDiv">
        <div id="weekDiv" class="leftDiv">
            <div class="weeksetup">
                <div id="daytypes" class="projectComponent">
                    <div class="item">
                        <img id="workday" class="menuicon daytype" src="img/workday.svg"/>
                    </div>
                    <div class="item">
                        <img id="holiday" class="menuicon daytype" src="img/holiday.svg"/>
                    </div>
                </div>
                <div id="week" class="dropzone droplist weekdays">
                    <div id="d1" class="weekday" data-value="1"><div class="dow">Mon</div></div>
                    <div id="d2" class="weekday" data-value="2"><div class="dow">Tue</div></div>
                    <div id="d3" class="weekday" data-value="3"><div class="dow">Wed</div></div>
                    <div id="d4" class="weekday" data-value="4"><div class="dow">Thu</div></div>
                    <div id="d5" class="weekday" data-value="5"><div class="dow">Fri</div></div>
                    <div id="d6" class="weekday" data-value="6"><div class="dow">Sat</div></div>
                    <div id="d0" class="weekday" data-value="0"><div class="dow">Sun</div></div>
                </div>
            </div>
        </div>

        <div class="rightDiv">
            <div id="blackouts" class="projectComponent">
                <div class="item">
                    <img class="menuIcon undraggable" src="img/edit.svg"
                        style="height: 40px; margin-bottom: 10px; margin-top: 10px;"/>
                </div>
            </div>    
            <div id="values">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr class="parameters">
                        <td class="capacitySetting" colspan="2"
                            style="border-bottom: 3px solid #666; border-right: 3px solid #666;">
                            <table>
                                <tr>
                                    <td class="rowLabel">
                                        <img class="undraggable" src="img/capacity.svg" style="height: 75px;"/>
                                    </td>
                                    <td class="capacitySetting">
                                        <img class="undraggable" src="img/lead.svg"/>
                                        <input id="lead" class="default"
                                            style="text-align: right; width: 4ch;"
                                            data-path="defaults.capacity.lead">%
                                    </td>
                                    <td class="capacitySetting">
                                        <img class="undraggable" src="img/developer.svg"/>
                                        <input id="developer" class="default"
                                            style="text-align: right; width: 4ch;"
                                            data-path="defaults.capacity.developer">%
                                    </td>        
                                </tr>
                            </table>
                        </td>
                        <td class="capacitySetting" style="border-bottom: 3px solid #666;">
                            <img src="img/estimate.svg" class="rowLabel undraggable" style="max-height: 78px;"/>
                            <input id="estimate" class="default"
                                style="text-align: right; width: 3ch;"
                                data-path="defaults.estimate">
                        </td>
                    </tr>
                    <tr>
                        <td class="capacitySetting" style="border-right: 3px solid #666;">
                            <img class="rowLabel undraggable" src="img/holiday.svg" style="width: 100px; height: 75px; margin-left: 3px;" alt="Time off">
                            <input id="vacation" class="default"
                                style="text-align: right; width: 5ch;"
                                data-path="defaults.capacity.vacation"> / <img src="img/devsprint.svg" style="height: 25px;">
                        </td>
                        <td class="capacitySetting" style="border-right: 3px solid #666;">
                            <img class="rowLabel undraggable" src="img/priority.svg" style="width: 100px; height: 75px; margin-left: 3px;" alt="Time off">
                            <select name="priority" id="priority" class="default"></select>
                        </td>
                        <td class="capacitySetting">
                            <img class="rowLabel undraggable" src="img/measure.svg" style="width: 100px; height: 75px;" alt="Time off">
                            <select name="size" id="size" class="default"></select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div id="teamForm" class="modal" style="display: none;">
        <div class="modal-container">
            <div class="container">
                <div onclick="document.getElementById('teamForm').style.display='none'" class="minbutton">×</div>
                <div class="formDescription">Role:</div>
                <div class="field">
                    <span>Name</span>
                    <input id="name" class="teamData" placeholder="Name">
                </div>
                <button id="yes">Save</button>
                <button id="no">Discard</button>
            </div>
        </div>
    </div>

    <div id="milestonesForm" class="modal" style="display: none;">
        <div class="modal-container">
            <div class="container">
                <div onclick="document.getElementById('milestonesForm').style.display='none'" class="minbutton">×</div>
                <div>&nbsp;</div>
                <div>
                    <label for="name">Sprint name:</label>
                    <input id="name" class="teamData" placeholder="Sprint name">
                    <label for="weeks">Weeks:</label>
                    <input id="weeks" class="teamData" style="width: 4ch;">
                </div>
                <div id="msdates"></div>
                <div>
                    <table class="capacitydata">
                        <tr id="teamlist"></tr>
                        <tr id="capacity"></tr>
                        <tr id="vacation"></tr>
                    </table>
                </div>
                <button id="yes">Save</button>
                <button id="no">Discard</button>
            </div>
        </div>
    </div>
    
    <div id="holidayWeeksForm" class="modal" style="display: none;">
        <div class="modal-container">
            <div class="container">
                <div onclick="document.getElementById('holidayWeeksForm').style.display='none'" class="minbutton">×</div>
                <br/>
                <div>
                    <label for="name">Blackout week:</label>
                    <input id="name" class="teamData" placeholder="Holiday name">
                </div>
                <div>
                    <label for="hollidayStart">Week:</label>
                    <input type="week" id="hollidayStart" class="monday" name="hollidayStart">
                </div>
                <br/>
                <button id="yes">Save</button>
                <button id="no">Discard</button>
            </div>
        </div>
    </div>

    <div id="loadfileForm" class="modal" style="display: none;">
        <div class="modal-container">
            <div class="container">
                <div onclick="document.getElementById('loadfileForm').style.display='none'" class="minbutton">×</div>
                <h1>Load Project File</h1>
                <input id="filename" type="file"/>
                <div style="padding-top: 20px;">
                    <button id="yes">Load</button>
                    <button id="no">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="savefileForm" class="modal" style="display: none;">
        <div class="modal-container">
            <div class="container">
                <div onclick="document.getElementById('savefileForm').style.display='none'" class="minbutton">×</div>
                <h1>Save Project File</h1>
                <input id="filename" style="width: 65ch;"/>
                <div style="padding-top: 20px;">
                    <button id="yes">Save</button>
                    <button id="no">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <template id="itemTemplate">
        <div class="item dropzone">
            <div class="icons">
                <div id="itemImage" class="control"></div>
                <div class="controls">
                    <img class="edit" src="img/edit.svg" style="width: 100%" draggable="false">
                    <img class="delete" src="img/delete.svg" style="width: 100%" draggable="false">
                </div>
                <div class="itemName"></div>
            </div>
            <div id="data" style="display: none;">{"name":"[Not Set]"}</div>
        </div>
    </template>
</div>

<div id="requirementsScreen" style="display: none;">
    <div id="backlogDiv">
        <div id="backlog" class="projectComponent">
            <div class="item task level1">
                <div style="background-color:gold;" class="postIt" draggable="true"></div>
            </div>
            <div class="item task level2">
                <div style="background-color:hotpink;" class="postIt" draggable="true"></div>
            </div>
            <div class="item task level3">
                <div style="background-color:rgb(142, 103, 194);" class="postIt" draggable="true"></div>
            </div>
        </div>
        <div id="requirements" class="dropzone backlog"></div>
    </div>
    <div id="requirementsForm" class="modal" style="display: none;">
        <div class="modal-container">
            <div class="container">
                <div onclick="document.getElementById('requirementsForm').style.display='none'" class="minbutton">×</div>
                <div>&nbsp;</div>
                <div><input id="name" class="teamData" placeholder="Requirement"></div>
                <div>
                    <textarea id="description" class="teamData" placeholder="Details"></textarea>
                </div>
                <div id="priorities">
                    <input type="radio" name="priority" class="teamData" id="musthave"/>
                    <label for="musthave" id="musthave">Must have</label>
                    <input type="radio" name="priority" class="teamData" id="shouldhave" checked/>
                    <label for="shouldhave" id="shouldhave">Should have</label>
                    <input type="radio" name="priority" class="teamData" id="nicetohave"/>
                    <label for="nicetohave" id="nicetohave">Nice to have</label>
                    <input type="radio" name="priority" class="teamData" id="optional"/>
                    <label for="option" id="optional">Optional</label>
                </div>
                <div id="estimate"></div>
                <button id="yes">Save</button>
                <button id="no">Discard</button>
            </div>
        </div>
    </div>    
</div>

<div id="scheduleScreen" style="display: none;">
    <div id="projectScheduleEditor" style="display: flex; width: 100%">
        <span id="backlogsummary" style="display: none;">
            <div id="backlogicon" class="divheader">
                <div class="divheader">
                    <div onclick="showBacklog()" class="minbutton">[]</div>
                </div>
            </div>
            <img id="show" class="reqtIcon" src="img/backlog.svg">
        </span>
        <span id="backlog">
            <div id="backlogDiv">
                <div class="divheader">
                    <div onclick="hideBacklog()" class="minbutton">X</div>
                </div>
                <div id="list" class="reqtlist"></div>
            </div>
        </span>
        <table id="mslist" class="mslayout">
            <colgroup>
                <col span="1">
                <col span="4">
            </colgroup>
            <thead>
                <tr class="toprow">
                    <th>
                        <img id="development" class="menuicon newtask" src="img/requirement.svg">
                    </th>
                    <th class="boardtitle">Stories</th>
                    <th class="boardtitle">In Progress</th>
                    <th class="boardtitle">In Test</th>
                    <th class="boardtitle">Complete</th>
                </tr>
            </thead>
            <tbody id="milestones"></tbody>
        </table>
    </div>

    <div id="milestoneEditor" style="display: none; width: 100%;">
        <div style="width: 100%;">
            <div class="return" style="display: flex; float: right;" onclick="showMilestones()">
                <img class="undraggable" style="width: 170px;" src="img/sprints.svg"/>
            </div>
            <span id="msicon" style="display: table-cell;"></span>
            <span id="msicon" style="display: table-cell; width: 100px; padding-left: 50px;">
                <img id="developer" class="menuicon person undraggable selected" src="img/developer.svg"
                    onclick="showDeveloperVeiw()">
            </span>
            <span id="msicon" style="display: table-cell;">
                <img id="tester" class="menuicon person undraggable" src="img/tester.svg"
                    onclick="showTesterView()">
            </span>
            <span id="header" style="display: table-cell;">
            </span>
        </div>
        <table id="devtasklist" class="mslayout">
            <colgroup>
                <col span="1">
                <col span="4">
            </colgroup>
            <thead>
                <tr class="toprow">
                    <th style="width: 100px;">
                        <img id="development" class="menuicon newtask" src="img/requirement.svg">
                    </th>
                    <th class="boardtitle">Stories</th>
                    <th class="boardtitle">In Progress</th>
                    <th class="boardtitle">In Test</th>
                    <th class="boardtitle">Complete</th>
                </tr>
            </thead>
            <tbody id="developer">
            </tbody>
            <tbody id="tester" style="display: none;">
            </tbody>
        </table>
        <table id="msbacklog" class="mslayout">
            <colgroup>
                <col span="1">
                <col span="4">
            </colgroup>
            <tbody></tbody>
         </table>
         <table id="qabacklog" class="mslayout" style="display: none;">
            <colgroup>
                <col span="1">
                <col span="4">
            </colgroup>
            <tbody></tbody>
         </table>
    </div>    

    <div id="taskForm" class="modal" style="display: none;">
        <div class="modal-container">
            <div class="container">
                <div onclick="document.getElementById('taskForm').style.display='none'" class="minbutton">×</div>
                <div>&nbsp;</div>
                <div>
                    <input id="name" class="teamData" placeholder="Label" />
                    <img id="editBurndown" src="img/flame.svg" style="height: 20px;" draggable="false"/>
                </div>
                <div><input id="details" class="teamData" placeholder="Details" /></div>
                <div id="estimate"></div>
                <button id="yes">Save</button>
                <button id="no">Discard</button>
            </div>
        </div>
    </div>

</div>

<div id="graphsScreen" style="display: none;">
    <div style="margin-top: 20px;padding-bottom: 20px;">
        <button id="milestone" class="graphType graphType-selected">Milestone</button>
        <button id="project"   class="graphType">Project</button>
        <button id="details"   class="graphType">Feature/Developer</button>
    </div>
    <div id="msChoice">
        <text>Milestone:
        <select id="selectMS"></select>
        </text>
    </div>
    <div id="graph"></div>
</div>

<div id="confirmDelete" class="modal" style="display: none;">
    <div class="modal-container">
        <div class="container">
            <p id="message">Realy delete this?</p>
            <button id="yes">Yes</button>
            <button id="no">No</button>
        </div>
    </div>
</div>

<div id="burndownForm" class="modal" style="display: none;">
    <div class="modal-container">
        <div class="container">
            <div class="form">
                <div onclick="document.getElementById('burndownForm').style.display='none'" class="minbutton">×</div>
                <div>
                    <span style="display: block; padding-top: 20px; padding-bottom: 10px;">
                        <b style="display: inline-block; width: 10ch;">Milestone:</b><span class="milestones"></span>
                    </span>
                    <div>
                        <span style="display: inline-block; width: 10ch;">
                            <b>Feature:</b></span><span id="taskbrief">
                        </span>
                        <img id="editTask" src="img/edit.svg" style="height: 20px;" draggable="false"/>
                    </div>
                    <div><span style="display: inline-block; width: 10ch;"><b>Estimate:</b></span><span id="estimate"></span></div>
                    <div id="daterange"></div>
                    <table>
                        <thead>
                            <tr>
                                <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th>
                                <th style="background-color: #9ac3c5;">Sat</th>
                                <th style="background-color: #9ac3c5;">Sun</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button id="yes">Save</button>
                <button id="no">Discard</button>
            </div>
            <div class="message" style="display: none;">
                <p></p><button id="exit">Close</button>
            </div>
        </div>
    </div>
</div>

<template id="msTemplate">
    <tr class="msrequirements">
        <td id="task" class="status msicon" style="min-width: 100px; padding: 3px;">
            <div class="minholder" style="width: 100%; display: inline-block;">
                <span class="description"></span>
                <img class="togglerow displayed" src="img/arrowright.svg" onclick="project.ui.ms.show(event.target)" style="display: none;"/>
                <img class="togglerow hidden" src="img/arrowdown.svg" onclick="project.ui.ms.hide(event.target)"/>
            </div>
        </td>
        <td id="task" class="status task dropzone"></td>
        <td id="task" class="status inprogress dropzone"></td>
        <td id="task" class="status totest dropzone"></td>
        <td id="task" class="status done dropzone"></td>
    </tr>
</template>

<template id="reqtTemplate">
    <div class="item taskbrief dropzone">
        <div id="controls" style="display: flow-root;">
            <span class="taskcontrols" style="float: right;">
                <img class="delete" src="img/delete.svg" draggable="false">
                <img class="edit" src="img/edit.svg" draggable="false">
            </span>
        </div>
        <div class="itemDescription"><p class="itemName"></p></div>
        <div id="data" style="display: none;">{"name":"[Not Set]"}</div>
    </div>
</template>

<template id="taskTemplate">
    <div class="item taskbrief dropzone">
        <div style="display: flow-root;">
            <div class="taskcontrols" style="display: inline-block; width: 100%;">
                <img class="delete" src="img/delete.svg" draggable="false">
                <img class="edit" src="img/edit.svg" draggable="false">
                <img class="burndown" src="img/flame.svg" draggable="false">
            </div>
            <div class="itemName itemDescription"></div>
            <div id="data" style="display: none;">{"name":"[Not Set]"}</div>
        </div>
    </div>
</template>

<template id="estimateTemplate">
    <input type="radio" name="size" class="teamData" value="1" id="dust"/>
    <label for="dust" id="dust">Dust</label>
    <input type="radio" name="size" class="teamData" value="2" id="grain"/>
    <label for="grain" id="grain">Grain</label>
    <input type="radio" name="size" class="teamData" value="3" id="pebble"/>
    <label for="pebble" id="pebble">Pebble</label>
    <input type="radio" name="size" class="teamData" value="5" id="stone" checked/>
    <label for="stone" id="stone" checked>Stone</label>
    <input type="radio" name="size" class="teamData" value="8" id="rock"/>
    <label for="rock" id="rock">Rock</label>
    <input type="radio" name="size" class="teamData" value="13" id="boulder"/>
    <label for="boulder" id="boulder">Boulder</label>
    <input type="radio" name="size" class="teamData" value="21" id="mountain"/>
    <label for="mountain" id="mountain">Mountain</label>
</template>

<script src="https://d3js.org/d3.v6.min.js"></script>

<script>
    const statuses = ["task", "inprogress", "totest", "done" ];
    var defaults = {
        "capacity": { "developer": 80, "lead": 40, "vacation": 1 },
        "estimate": 3,
        "priority": "nicetohave",
        "size": "stone",
        "sprintLenth": 2,
        "burndownDays": [1, 3, 5],
        "weeklyHolidays": [0, 6]
    };
    var dragdrop = {
        dragged: null, left: 0, top: 0,
        config: {
            // Droppin object class in bin or other item to create item or insert item in list
            "person": [
                { "target": "people", "handler": "dragdrop.add('teamMember', event.target)" },
                { "target": "teamMember", "handler": "dragdrop.insertArtifact('#team', dragdrop.dragged, dropzone, '.' + 'person')" }
            ],
            "milestone": [
                { "target": "schedule", "handler": "dragdrop.add('scheduleMS', event.target)" },
                { "target": "scheduleMS", "handler": "dragdrop.insertArtifact('#milestones', dragdrop.dragged, dropzone, '.' + 'milestone')" }
            ],
            "blackout": [
                { "target": "holidayWeeks", "handler": "dragdrop.add('holidayWeek', event.target)" },
                { "target": "holidayWeek", "handler": "dragdrop.insertArtifact('#blackouts', dragdrop.dragged, dropzone, '.' + 'blackout')" }
            ],
            "requirement": [
                { "target": "backlog", "handler": "dragdrop.add('workItem', event.target, event)" },
                { "target": "workItem", "handler": "dragdrop.insertArtifact('div#requirements', dragdrop.dragged, dropzone, '.' + 'requirement', event)" }
            ],
            "postIt": [
                { "target": "backlog", "handler": "dragdrop.add('workItem', event.target, event)" },
                { "target": "workItem", "handler": "dragdrop.insertArtifact('div#requirements', dragdrop.dragged, dropzone, '.' + 'requirement', event)" }
            ],
            "daytype": [
                { "target": "weekdays", "handler": "dragdrop.add('dayOfWeek', event.target)" },
                { "target": "dayOfWeek", "handler": "dragdrop.add('dayOfWeek', event.target)" }
            ],
            "newtask": [
                { "target": "status", "handler": "dragdrop.add('newTask', event.target)" },
                { "target": "taskbrief", "handler": "dragdrop.insertTask(dropzone, dropzone.closest('td'), event)" }
            ],
            "backlogitem": [
                { "target": "status", "handler": "dragdrop.add('backlogitem', event.target)" },
                { "target": "taskbrief", "handler": "dragdrop.insertTask(dropzone, dropzone.closest('td'), event)" }
            ],
            // Droping item on another item in bin or at end of bin
            "teamMember": [
                { "target": "people", "handler": "dragdrop.moveChildToEnd(dragdrop.dragged, event.target)" },
                { "target": "teamMember", "handler": "dragdrop.moveChildBefore(dragdrop.dragged, event.target)" }
            ],
            "scheduleMS": [
                { "target": "schedule", "handler": "dragdrop.moveChildToEnd(dragdrop.dragged, event.target)" },
                { "target": "scheduleMS", "handler": "dragdrop.moveChildBefore(dragdrop.dragged, event.target)" }
            ],
            "holidayWeek": [
                { "target": "holidayWeeks", "handler": "dragdrop.moveChildToEnd(dragdrop.dragged, event.target)" },
                { "target": "holidayWeek", "handler": "dragdrop.moveChildBefore(dragdrop.dragged, event.target)" }
            ],
            "dayOfWeek": [
                { "target": "weekdays", "handler": "dragdrop.moveChildTo(dragdrop.dragged, event.target)" },
                { "target": "dayOfWeek", "handler": "dragdrop.moveChildTo(dragdrop.dragged, event.target)" }
            ],
            "workItem": [
                { "target": "backlog", "handler": "dragdrop.moveChildToEnd(dragdrop.dragged, event.target)" },
                { "target": "workItem", "handler": "dragdrop.moveChildBefore(dragdrop.dragged, event.target)" }
            ],
            "taskbrief": [
                { "target": "status", "handler": "dragdrop.appendDraggedTask(dragdrop.dragged, event.target)" },
                { "target": "backlog", "handler": "dragdrop.moveTask(dragdrop.dragged, event)" },
                { "target": "taskbrief", "handler": "dragdrop.moveTask(dragdrop.dragged, event)" }
            ]
        },
        dragstart: function (event) {
            this.dragged = event.target;
            var rect = event.target.getBoundingClientRect();
            this.left = event.x - rect.x;
            this.top = event.y - rect.y;
        },
        drop: function (event) {
            var dropzone = event.target.closest(".dropzone");
            if (!dropzone) return;
            // Find config with entry matching class name of dragdrop.dragged item
            var callbackentry = draggableObjects.filter(f => dragdrop.dragged.classList.contains(f));
            if (callbackentry.length != 1) {
                console.log("Drop handler configured error for #" + dragdrop.dragged.id.replace(/\./, "\\.") + "."
                    + [...dragdrop.dragged.classList].join(".") + ":", callbackentry.length, "entries matched");
                if (callbackentry.length > 1) console.log("Matching entries:", callbackentry.join(", "))
                return; 
            }
            var callback = dragdrop.config[callbackentry[0]].filter(f => dropzone.classList.contains(f.target));
            if (!callback.length) {
                console.log("No rule to drop class [" + callbackentry[0] + "] on [" + dropzone.classList.toString() + "]");
                return;
            }
            console.log("\nDragged:\n\t#" + dragdrop.dragged.id + ".[" + dragdrop.dragged.classList + "]\nDropped on:\n\t#"
                + event.target.id + ".[" + event.target.classList + "]\nClosets dropzone:\n\t#" + dropzone.id
                + ".[" + dropzone.classList + "]\nCallback handler:\n\t",
                callback[0].handler, callback.length > 1 ? callback.length + " handlers found\n" : "\n",
                callbackentry + ":", callback, "\n-----------\n");
            eval(callback[0].handler);
        },
        add: function (itemClass, target, event) {
            var newInstance = dragdrop.new(target.id, instanceTemplates[itemClass], event);
            var id = newInstance.firstElementChild.id;
            var item = newInstance.querySelector(".item");
            item.classList.add(itemClass);
            target.appendChild(newInstance);
            if (itemClass == "workItem") {
                item.classList.remove("workItem");
                item.style.backgroundColor = dragdrop.dragged.style.backgroundColor;
                item.style.position = "absolute";
                var rect = event.target.getBoundingClientRect();
                var x = event.clientX - rect.left - this.left;
                if (x < 0) x = 0;
                var y = event.clientY - rect.top - this.top;
                if (y < 0) y = 0;
                item.style.left = x.toString();
                item.style.top = y.toString();
            }
            document.getElementById(id).draggable = true;
            callFuntion("onadd_" + itemClass, document.getElementById(id));
            return document.getElementById(id);
        },
        new: function (artClass, instTemplate, event) {
            // New instance, like a developer or tester
            var itemTemplate = document.getElementById(instTemplate);
            var item = itemTemplate.content.cloneNode(true);
            var id = artClass + '.' + (+new Date());
            item.querySelector('.item').setAttribute('id', id);
            item.querySelector('.edit').onclick = form.edit;
            item.querySelector('.delete').onclick = deleteItem;
            var data = getJSONData(item);
            item.querySelector('.itemName').innerText = data["name"];
            // Add developer/tester icon
            var icon = dragdrop.dragged.cloneNode(true);
            icon.setAttribute('draggable', false);
            var imageHolder = item.getElementById('itemImage');
            imageHolder && imageHolder.appendChild(icon);
            return item;
        },
        insertArtifact: function (box, droppedImg, droppedOn, imgSelector, event) {
            var bin = document.querySelector(box);
            // Back up to the box with the person
            while (droppedOn.parentElement && droppedOn.parentElement.id != bin.id)
                droppedOn = droppedOn.parentElement;
            if (!droppedOn || !droppedOn.parentElement) {
                console.log(droppedImg, "was not dropped in the bin", bin)
                return;
            }
            // Create node before the node on which it was dropped
            var newChild = dragdrop.new(bin.id, 'itemTemplate', event);
            var id = newChild.firstElementChild.id;
            newChild.querySelector(".item").classList = droppedOn.classList;
            bin.insertBefore(newChild, droppedOn);
            var newInstance = document.querySelector("#" + id.replace(/\./, "\\."));
            // Replace image with dropped image
            var itemImage = newInstance.querySelector("#itemImage");
            itemImage.querySelector(imgSelector).draggable = false;
            document.getElementById(id).draggable = true;
            callFuntion("oninsert_" + bin.id, document.getElementById(id));
        },
        insertTask: function (onTask, onCell, event) {
            onTask = onTask.closest(".dropzone");
            var newChild = dragdrop.new("task", "taskTemplate", event);
            var id = newChild.firstElementChild.id;
            newChild.querySelector(".item").classList = onTask.classList;
            onCell.insertBefore(newChild, onTask);
            document.getElementById(id).draggable = true;
            if (dragdrop.dragged.classList.contains('backlogitem')) {
                var newrequirement = document.getElementById(id);
                newrequirement.querySelector(".itemName").innerText = dragdrop.dragged.innerText;
                form.initData("#requirementsForm", newrequirement);
            }
            callFuntion("oninsert_" + onCell.id, document.getElementById(id));
        },
        moveChildToEnd: function (child, list) {
            var moved = list.removeChild(child);
            list.appendChild(moved);
            var lastClass = child.classList.length - 1;
            callFuntion("onmovetoend_" + child.classList[lastClass], list);
        },
        moveChildBefore: function (child, droppedOn) {
            // Back up to the box with the person
            while (droppedOn.parentElement && droppedOn.parentElement.id != "team")
                droppedOn = droppedOn.parentElement;
            if (child.isSameNode(droppedOn) || (droppedOn.parentElement != "team")) return;
            droppedOn.parentElement.insertBefore(child, droppedOn);
            var lastClass = child.classList.length - 1;
            callFuntion("onmovechildbefore_" + child.classList[lastClass], droppedOn);
        },
        moveChildTo: function (child, droppedOn) {
            if (child.closest(".weekday") == droppedOn.closest(".weekday")) return;
            var weekday = droppedOn.closest(".weekday");
            weekday.querySelectorAll(":not(.dow)").forEach(n => n.parentNode.removeChild(n));
            weekday.appendChild(child);
        },
        moveTask: function (task, event) {
            var rect = event.target.closest("#requirements").getBoundingClientRect();
            var x = event.clientX - rect.left - this.left;
            if (x < 0) x = 0;
            var y = event.clientY - rect.top - this.top;
            if (y < 0) y = 0;
            task.style.left = x.toString();
            task.style.top = y.toString();
        },
        appendDraggedTask: function (task, cell) {
            var role = cell.closest("tbody").id;
            task.querySelector("#data").innerText = JSON.stringify(assignTask(task, cell, role));
            if (cell.classList.contains("done")) {
                // If date is after end of project, record as done date
            }
            // Delete task from old box, instern in new
            cell.appendChild(task);
            // Make the same change in both MS and schedule screens. Detect active screen using table ID
            var tableID = cell.closest("table").id;
            // If task was moved in MS editor screen, clone task to project editor screen
            if (tableID == "devtasklist") {
                var data = assignTask(task, cell, role);
                var taskCopy = task.cloneNode(true);
                taskCopy.querySelector(".burndown").onclick = editBurndown;
                taskCopy.querySelector(".edit").onclick = form.edit;
                taskCopy.querySelector(".delete").onclick = deleteItem;
                var oldTask = document.querySelector("#mslist #" + task.id.replace(/\./, "\\."));
                if (oldTask) {
                    msRow = oldTask.closest("tr");
                    oldTask.remove();
                    msRow.querySelector("." + Array.from(cell.classList).join('.')).appendChild(taskCopy);
                    var status = statuses.filter(f => cell.classList.contains(f))[0];
                    document.querySelectorAll("#" + task.id.replace(/\./, "\\.")).forEach(t => {
                        var destination = t.closest("tr").querySelector("." + status);
                        destination.appendChild(t);
                    });
                }
            }
            if (cell.classList.contains("done")) { // set remaining effort to 0
                var msid = cell.closest("tr").id;
                if (msid == '')
                    msid = cell.closest("#milestoneEditor").querySelector(".scheduleMS").id;
                var statusDate = new Date();
                var projectStart = project.dates.start();
                if (statusDate < projectStart) statusDate = projectStart;
                var msEndDate = project.milestones.get({ id: msid }).endDate();
                if (statusDate > msEndDate) statusDate = msEndDate;
                var dt = "dt_" + (statusDate.toISOString().slice(0,10).replace(/-/g,""));
                var data = getJSONData(task);
                data[dt] = "0";
                document.querySelectorAll("#" + task.id.replace(/\./, "\\."))
                    .forEach(t => t.querySelector("#data").innerText = JSON.stringify(data));
            }
        }
    }
    var draggableObjects = Object.keys(dragdrop.config);
    var instanceTemplates = {
        "teamMember": "itemTemplate",
        "scheduleMS": "itemTemplate",
        "holidayWeek": "itemTemplate",
        "dayOfWeek": "itemTemplate",
        "workItem": "reqtTemplate",
        "backlogitem": "taskTemplate",
        "newTask": "taskTemplate"
    };
    var project = {
        burndown: {
            capacity: function(date) {
                return project.milestones.getDev().map(m => this.getMilestone(m).capacity(date)).reduce((a, b) => a + b);
            },
            get: function() {
                var tasks = project.tasks.getAll();
                var allBurndown = [];
                tasks.forEach(t => {
                    allBurndown.push({ id: t.id, burndown: project.tasks.get(t.id).getProjectBurndown()});
                });
                var dates = project.dates.trackingDates();
                var burndown = [];
                dates.forEach(d => {
                    dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                    var allEfforts = allBurndown.map(b => b.burndown.filter(d => d.date == dt)[0].effort);
                    burndown.push({
                        date: dt,
                        effort: allEfforts.length ? allEfforts.reduce((a, b) => a + b) : 0
                    });
                });
                return burndown;
            },
            getTarget: function() {
                var capacityData = [];
                project.dates.trackingDates().forEach(d => {
                    var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                    capacityData.push({
                        date: dt,
                        effort: [...project.milestones.getAll()]
                            .map(m => project.milestones.get(m).capacity(d))
                            .reduce((a, b) => a + b)
                    });
                });
                return capacityData;
            },
        },
        backlog: {
            getAll: function() {
                return Array.from(document.querySelectorAll("#backlogDiv #requirements .item"));
            },
            get: function(reqtId) {
                return {
                    id: reqtId,
                    data: function() {
                        return getJSONData(document.querySelector("#" + this.id.replace(/\./, "\\.")));
                    }
                }
            }
        },
        milestones: {
            get: function(ms) {
                return {
                    id: ms.id,
                    startDate: function() {
                        var startDate = project.dates.start();
                        if (startDate == null) return null;
                        var milestones = Array.from(document.querySelectorAll("#settingsScreen .scheduleMS"));
                        var milestone = milestones.filter(m => m.id == this.id)[0];
                        var weeks = 0;
                        for (var m = 0; m < milestones.length; m++) {
                            if (milestones[m].isSameNode(milestone)) break;
                            weeks += +getJSONData(milestones[m]).weeks;
                        }
                        var dt = new Date(startDate);
                        return new Date(dt.setDate(dt.getDate() + (weeks * 7)));
                    },
                    endDate: function() {
                        var dt = this.startDate();
                        return  dt == null ? null :
                            new Date(dt.setDate(dt.getDate() + (this.dataValue("weeks") * 7) - 1));
                    },
                    tasks: function() {
                        var selector = "#mslist #" + this.id.replace(/\./, "\\.") + " .newTask";
                        return Array.from(document.querySelectorAll(selector));
                    },
                    unassignedDeveloper: function() {
                        return this.tasks().filter(t => {
                            developer = project.tasks.get(t.id).data().developer;
                            return developer == null || developer == ''; })
                    },
                    unassignedTester: function() {
                        return this.tasks().filter(t => {
                            tester = project.tasks.get(t.id).data().tester;
                            return tester == null || tester == ''; })
                    },
                    trackingDates: function() {
                        var date = new Date(this.startDate());
                        var endDate = this.endDate();
                        var burndownDays = project.dates.burndownDays();
                        var trackingDates = [];
                        while (date < endDate) {
                            burndownDays.forEach(d => {
                                var dt = new Date(date);
                                dt.setDate(dt.getDate() + d - 1);
                                trackingDates.push(new Date(dt));
                            });
                            date = new Date(date.setDate(date.getDate() + 7));
                        }
                        return trackingDates;
                    },
                    capacity: function(date) {
                        if (document.querySelector("#settingsScreen #" + this.id.replace(/\./, "\\."))
                            .classList.contains("testing")) return 0;
                        if (!date || date < this.startDate()) date = this.startDate();
                        if (date >= this.endDate()) return 0;
                        var endDate = this.endDate();
                        var data = this.data();
                        var capacity = 0;
                        var developers = project.team.getDevelopers();
                        // Accumulate developer capacity = vacation across team 
                        developers.forEach(d => {
                            if (!data[d]) return;
                            var burnRate = parseInt(data[d]) / 100;
                            var vacation = parseInt(data["vac_" + d]); 
                            var devCapacity = 0;
                            for(var dt = new Date(date); dt < endDate; dt.setDate(dt.getDate() + 1)) {
                                if (!project.dates.isHoliday(dt)) devCapacity += burnRate;
                            }
                            devCapacity -= vacation;
                            if (devCapacity < 0) devCapacity = 0;
                            capacity += devCapacity;
                        });
                        return capacity;
                    },
                    capacityConfig: function() {
                        if (document.querySelector("#settingsScreen #" + this.id.replace(/\./, "\\."))
                            .classList.contains("testing")) return null;
                        var data = this.data();
                        var capacity = [];
                        var developers = project.team.getDevelopers();
                        developers.forEach(d => {
                            if (!data[d]) return;
                            var vacation = parseInt(data["vac_" + d]); 
                            var devCapacity = 0;
                            capacity.push({
                                id: d,
                                developer: project.team.getDeveloper(d).data().name,
                                availability: data[d],
                                vacation: vacation
                            });
                        });
                        return capacity;
                    },
                    developerCapacity: function(developer, date) {
                        if (document.querySelector("#settingsScreen #" + this.id.replace(/\./, "\\."))
                            .classList.contains("testing")) return 0;
                        if (date >= this.endDate()) return 0;
                        var data = this.data();
                        if (!data[developer]) return 0;
                        if (!date || date < this.startDate()) date = this.startDate();
                        var workingDays = this.workingDays();
                        var vacation = parseInt(data["vac_" + developer]); 
                        var burnTotal = (parseInt(data[developer]) / 100) * (workingDays.length - vacation);
                        var burnRate = burnTotal / workingDays.length;
                        if (burnRate < 0) burnRate = 0;
                        var endDate = this.endDate();
                        var capacity = 0;
                        for(var dt = new Date(date); dt < endDate; dt.setDate(dt.getDate() + 1)) {
                            if (!project.dates.isHoliday(dt)) capacity += burnRate;
                        }
                        capacity -= vacation;
                        if (capacity < 0) capacity = 0;
                        return capacity;
                    },
                    targetBurndown: function() {
                        var burndown = [];
                        var trackingDates = this.trackingDates();
                        trackingDates.forEach(d => {
                            var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                            burndown.push({ date: dt, effort: this.capacity(d) });
                        });
                        return burndown;
                    },
                    burndown: function() {
                        var tasks = this.tasks();
                        var allBurndown = [];
                        tasks.forEach(t => {
                            allBurndown.push({
                                id: t.id,
                                burndown: project.tasks.get(t.id).getProjectBurndown()
                            });
                        });
                        var dates = this.trackingDates();
                        var burndown = [];
                        dates.forEach(d => {
                            var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                            var allEfforts = allBurndown.map(b => b.burndown.filter(b => b.date == dt)[0].effort);
                            burndown.push({
                                date: dt,
                                effort: allEfforts.length ? allEfforts.reduce((a, b) => a + b) : 0
                            });
                        });
                        return burndown;
                    },
                    workingDays: function() {
                        var workingDays = [];
                        var endDate = this.endDate();
                        for (var date = this.startDate(); date < endDate; date.setDate(date.getDate() + 1)) {
                            if (!project.dates.isHoliday(date)) workingDays.push(new Date(date));
                        }
                        return workingDays;
                    },
                    data: function() {
                        var selector = "#settingsScreen #" + this.id.replace(/\./, "\\.");
                        return getJSONData(document.querySelector(selector));
                    },
                    dataValue: function(attribute) {
                        return this.data()[attribute];
                    }
                }
            },
            getAll: function() {
                return document.querySelectorAll("#settingsScreen .scheduleMS");
            },
            getDev: function() {
                return [...document.querySelectorAll("#settingsScreen #milestones img#development")]
                    .map(d => d.closest(".scheduleMS"));
            }
        },
        tasks: {
            get: function(taskid) {
                return {
                    id: taskid,
                    data: function() {
                        return getJSONData(document.querySelector("#" + this.id.replace(/\./, "\\.")));
                    },
                    getSize: function() {
                        var data = this.data();
                        var sizes = [...document.querySelector("#estimateTemplate")
                            .content.querySelectorAll("input")].map(s => s.id).filter(d => data[d]);
                        if (sizes.length == 0) return 0;
                        return sizes[sizes.length - 1];
                    },
                    getEstimate: function() {
                        return +document.querySelector("#estimateTemplate").content
                            .querySelector("input#" + this.getSize()).value;
                    },
                    getProjectBurndown: function() {
                        var startDate = project.dates.start();
                        if (!startDate) return [];
                        var endDate = project.dates.end();
                        var remainingEffort = this.getEstimate();
                        var task = document.querySelector("#" + this.id.replace(/\./, "\\."));
                        var data = getJSONData(task);
                        var allDays = {};
                        for (var d = startDate; d < endDate; d.setDate(d.getDate() + 1)) {
                            var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                            if (data[dt] && data[dt] != '') remainingEffort = parseInt(data[dt]);
                            allDays[dt] = remainingEffort;
                        }
                        var burndown = [];
                        var trackingDates = project.dates.trackingDates();
                        trackingDates.forEach(d => {
                            var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                            burndown.push({ date: dt, effort: allDays[dt] });
                        });
                        return burndown;
                    },
                    getMSBurndown: function(msid) {
                        var  taskBurndown = this.getProjectBurndown();
                        var dates = project.milestones.get(msid).trackingDates();
                        burndown = [];
                        dates.forEach(d => {
                            var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                            burndown.push({
                                date: dt,
                                effort: taskBurndown.filter(b => b.date == dt)[0].effort
                            });
                        })
                        return burndown;
                    },
                    getRemaimingEffort: function () {
                        var burndown = this.getProjectBurndown();
                        var dates = [...Object.keys(burndown)];
                        return burndown[dates[dates.length - 1]];
                    },
                    getMSRemaimingEffort: function (msid) {
                        var msburndown = this.getMSBurndown(msid);
                        var dates = [...Object.keys(msburndown)];
                        return msburndown[msburndown.length - 1];
                    }
                }
            },
            getAll: function() {
                return Array.from(document.querySelectorAll("#mslist div.newTask"));
            }
        },
        team: {
            getDevelopers: function() {
                return Array.from(document.querySelectorAll("#settingsScreen #team .lead"))
                    .concat(Array.from(document.querySelectorAll("#settingsScreen #team .developer")))
                    .map(d => d.id);
            },
            getDeveloper: function(developerId) {
                return {
                    id: developerId,
                    data: function() {
                        return getJSONData(document.querySelector("#settingsScreen #" + this.id.replace(/\./, "\\.")));
                    },
                    tasks: function() {
                        return project.tasks.getAll().filter(f => {
                            var data = project.tasks.get(f.id).data();
                            return data.developer ? data.developer == this.id : false;
                        });
                    },
                    getTasksForMS: function(milestoneId) {
                        return this.tasks().filter(t => t.closest("tr").id == milestoneId);
                    }
                }
            },
            getQAs: function() {
                return Array.from(document.querySelectorAll("#settingsScreen #team .tester")).map(d => d.id);
            },
            getTeam: function()  {
                return Array.from(document.querySelectorAll("#settingsScreen #team .teammember")).map(d => d.id);
            }
        },
        dates: {
            start: function() {
                return document.querySelector("#settingsScreen #startDate").value != '' ?
                    new Date(document.querySelector("#settingsScreen #startDate").value) : null;
            },
            end: function() {
                var milestones = project.milestones.getAll();
                var lastMS = milestones[milestones.length - 1];
                return project.milestones.get(lastMS).endDate();
            },
            burndownDays: function() {
                var burndownDays = [];
                document.querySelectorAll("#weekDiv .weekday #workday")
                    .forEach(w => {
                        burndownDays.push(+w.closest(".weekday").getAttribute("data-value"));
                    });
                return burndownDays;
            },
            weeklyHolidays: function() {
                var weeklyHolidays = [];
                document.querySelectorAll("#weekDiv .weekday #holiday")
                    .forEach(w => {
                        weeklyHolidays.push(+w.closest(".weekday").getAttribute("data-value"));
                    });
                return weeklyHolidays;
            },
            blackoutWeeks: function() {
                return [...document.querySelectorAll("#settingsScreen .holidayWeek")]
                    .filter(d => d.hollidayStart).map(d => getJSONData(d)).map(d => {
                        var w = parseInt(d.hollidayStart.split("W")[1]);
                        var y = parseInt(d.hollidayStart.split("-")[0]);
                        var d = (1 + (w - 1) * 7);
                        return new Date(y, 0, d);
                    });
            },
            blackoutDays: function() {
                var holidays = [];
                this.blackoutWeeks().forEach(w => {
                    if (!w) return;
                    var d = new Date(w);
                    var workdaysPerWeek = 7 - defaults.weeklyHolidays.length;
                    for (i = 0; i < workdaysPerWeek; i++) {
                        holidays.push(new Date(d));
                        d.setDate(d.getDate() + 1);
                    }
                });
                return holidays;
            },
            trackingDates: function() {
                var date = new Date(this.start());
                var endDate = this.end();
                var burndownDays = project.dates.burndownDays();
                var trackingDates = [];
                while (date < endDate) {
                    burndownDays.forEach(d => {
                        var dt = new Date(date); 
                        dt.setDate(dt.getDate() + d - 1);
                        trackingDates.push(new Date(dt));
                    });
                    date = new Date(date.setDate(date.getDate() + 7));
                }
                return trackingDates;
            },
            isHoliday: function(date) {
                var blackoutDays = this.blackoutDays();
                if (blackoutDays.filter(d => d.getDate() == date.getDate()).length > 0) return true;
                var dow = date.getDay();
                return project.dates.weeklyHolidays().filter(d => d == dow).length > 0;
            }
        },
        ui: {
            clear: function() {
                document.querySelectorAll("#projectInfo input").forEach(f => f.value = "");
                document.querySelector("#requirementsScreen #requirements").innerHTML = "";
                document.querySelectorAll(".droplist:not(.weekdays)").forEach(d => d.innerHTML = "");
                document.querySelectorAll(".droplist .weekday .item").forEach(w => w.parentNode.removeChild(w));
                document.querySelector("#mslist #milestones").innerHTML = "";
                document.querySelector("#backlog #list").innerHTML = "";
            },
            ms: {
                hide: function(target) {
                    target.closest("td").querySelectorAll("div:not(.minholder)").forEach(div => div.style.display = "none");
                    var minholder = target.closest(".minholder");
                    minholder.querySelector(".description").innerText =
                        target.closest("td").querySelector(".itemName").innerText;
                    minholder.querySelector(".displayed").style.display = "";
                    minholder.querySelector(".hidden").style.display = "none";
                    target.closest("tr").querySelectorAll("td:not(.msicon)").forEach(c => c.style.display = "none");
                },
                show: function(target) {
                    target.closest("td").querySelectorAll("div:not(.minholder):not(#data)")
                        .forEach(div => div.style.display = "");
                    var minholder = target.closest(".minholder");
                    minholder.querySelector(".description").innerText = "";
                    minholder.querySelector(".hidden").style.display = "";
                    minholder.querySelector(".displayed").style.display = "none";
                    target.closest("tr").querySelectorAll("td:not(.msicon)").forEach(c => c.style.display = "");
                }
            }
        },
        file: {
            open: function() {
                var form = document.querySelector("#loadfileForm");
                form.style.display = "";
                form.querySelector("#yes").addEventListener("click", function() {
                    if (form.querySelector("#filename").value == '') return;
                    var file = document.querySelector("#loadfileForm #filename").files[0];
                    var reader = new FileReader();
                    reader.readAsText(file);
                    reader.onload = function() {
                        project.ui.clear();
                        var data = JSON.parse(reader.result);
                        for (var d in data.projectInfo) {
                            if (d == "burndownDays" || d == "weeklyHolidays") {
                                var daytype = d == "burndownDays" ? "workday" : "holiday";
                                data.projectInfo[d].forEach(i => {
                                    var day = [...document.querySelectorAll("#week .weekday")]
                                        .filter(d => d.getAttribute("data-value") == i)[0];
                                        dragdrop.dragged = document.querySelector("img#" + daytype);
                                        dragdrop.add('dayOfWeek', day);
                                });
                                continue;
                            }
                            var input = document.querySelector("#projectInfo input#" + d);
                            if (input)
                                input.value = data.projectInfo[d];
                            else {
                                input = document.querySelector("#defaults input#" + d);
                                if (!input) {
                                    input = document.querySelector("#defaults select#" + d);
                                    input.selected = data.projectInfo[d];
                                }
                                else {
                                    if (input.type == 'checkbox') input.checked = data.projectInfo[d];
                                    else input.value = data.projectInfo[d];
                                }
                            }
                        }
                        for (var d in data.defaults) {
                            document.querySelector("#defaults input#" + d).value = data.projectInfo[d];
                        }
                        for (var i in data.team) {
                            var id = data.team[i].id;
                            var teamData = data.team[i].data;
                            role = teamData.role ? teamData.role : "developer";
                            dragdrop.dragged = document.querySelector("#people img#" + role);
                            var teamMember = dragdrop.add("teamMember", document.querySelector("#team"));
                            teamMember.id = id;
                            teamMember.querySelector(".itemName").innerText = teamData.name;
                            teamMember.querySelector("#data").innerText = JSON.stringify(teamData);
                        }
                        for (var i in data.milestones) {
                            var id = data.milestones[i].id;
                            var msData = data.milestones[i].data;
                            type = data.milestones[i].data.type;
                            dragdrop.dragged = document.querySelector("#msTypes img#" + type);
                            var ms = dragdrop.add("scheduleMS", document.querySelector("#milestones"));
                            trackingMS = document.querySelector("#mslist #" + ms.id.replace(/\./, "\\."));
                            if (trackingMS) {
                                trackingMS.id = id;
                                trackingMS.querySelector(".itemName").innerText = msData.name;
                                trackingMS.querySelector(".scheduleMS").id = id;
                            }
                            ms.id = id;
                            ms.querySelector(".itemName").innerText = msData.name;
                            ms.querySelector("#data").innerText = JSON.stringify(msData);
                        }
                        for (var i in data.holidayWeeks) {
                            var id = data.holidayWeeks[i].id;
                            var hwData = data.holidayWeeks[i].data;
                            dragdrop.dragged = document.querySelector("#blackouts img");
                            var hw = dragdrop.add("holidayWeek", document.querySelector("#holidayWeeks"));
                            hw.id = id;
                            hw.querySelector(".itemName").innerText = hwData.name;
                            hw.querySelector("#data").innerText = JSON.stringify(hwData);
                        }
                        for (var i in data.requirements) {
                            var id = data.requirements[i].id;
                            var rqtData = data.requirements[i].data;
                            dragdrop.dragged = document.querySelector("#backlogDiv #backlog ." + rqtData.level + " .postIt");
                            var event = {
                                x: parseInt(rqtData.left),
                                y: parseInt(rqtData.top)
                            }
                            var rqt = dragdrop.add("workItem", document.querySelector("#backlogDiv #requirements"), event);
                            var origId = rqt.id;
                            rqt.id = id;
                            rqt.querySelector(".itemName").innerText = rqtData.name;
                            rqt.querySelector("#data").innerText = JSON.stringify(rqtData);
                            var oldReq = document.querySelector("#backlog #list #" + origId.replace(/\./, "\\."));
                            oldReq.innerText = rqtData.name;
                            oldReq.id = id;
                        }
                        project.file.loadTrackingData(data.burndown);
                    }
                    form.style.display = "none";
                });
                form.querySelector("#no").addEventListener("click", function() {
                    form.style.display = "none";
                });
            },
            loadTrackingData: function(burndown) {
                var table = document.querySelector("#mslist");
                burndown.forEach(milestone => {
                    var tr = table.querySelector("tr#" + milestone.id.replace(/\./, "\\."));
                    statuses.forEach(status => {
                        milestone[status].forEach(task => {
                            var data = task.data;
                            dragdrop.dragged = document.querySelector("#mslist #development");
                            var newTask = dragdrop.add("newTask", tr.querySelector("." + status));
                            newTask.id = task.id;
                            newTask.querySelector(".itemName").innerText = data.name;
                            newTask.querySelector("#data").innerText = JSON.stringify(data);
                            var reference = data.reference;
                            if (reference) {
                                var s = "#requirements #" + data.reference.replace(/\./, "\\.");
                                newTask.style.backgroundColor = document.querySelector(s).style.backgroundColor;
                            }
                        });
                    })
                })
            },
            save: function() {
                var form = document.querySelector("#savefileForm");
                form.style.display = "";
                var dt = (new Date()).toISOString().split(".")[0];
                var projectName = document.querySelector("#projectName").value;
                if (projectName == "") projectName = "Project";
                form.querySelector("#filename").value = projectName + "." + dt;
                form.querySelector("#yes").addEventListener("click", function() {
                    var filename = this.closest("#savefileForm").querySelector("#filename").value;
                    console.log("Save project to", filename);
                    if (form.querySelector("#filename").value == '') return;
                    blob = new Blob([JSON.stringify(project.file.toJSON(), null, 2)], {
                        type: "application/json;charset=utf-8"
                    });
                    if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                        window.navigator.msSaveOrOpenBlob(blob, filename);
                    }
                    else {
                        var a = document.createElement('a');
                        a.download = filename;
                        a.href = URL.createObjectURL(blob);
                        a.dataset.downloadurl = ['text/plain', a.download, a.href].join(':');
                        a.dispatchEvent(new MouseEvent('click', {
                            'view': window,
                            'bubbles': true,
                            'cancelable': false
                        }));
                    }
                    form.style.display = "none";
                });
                form.querySelector("#no").addEventListener("click", function() {
                    form.style.display = "none";
                });
            },
            toJSON: function() {
                var json = {
                    projectInfo: {},
                    defaults: {},
                    team: [],
                    milestones: [],
                    holidayWeeks: [],
                    requirements: [],
                    burndown: []
                };
                document.querySelectorAll("#projectInfo input").forEach (v => {
                    json.projectInfo[v.id] = v.value;
                });
                json.projectInfo.burndownDays = project.dates.burndownDays();
                json.projectInfo.weeklyHolidays = project.dates.weeklyHolidays();
                document.querySelectorAll("#defaults input").forEach (v => {
                    if (v.type == 'checkbox')
                        json.projectInfo[v.id] = v.checked;
                    if (v.type == 'text')
                        json.projectInfo[v.id] = v.value;
                });
                document.querySelectorAll("#defaults select").forEach (v => {
                    json.projectInfo[v.id] = v.value;
                });
                document.querySelectorAll("#team .teamMember").forEach(t => {
                    json.team.push({ id: t.id, data: getJSONData(t) });
                });
                document.querySelectorAll("#milestones .scheduleMS").forEach(t => {
                    json.milestones.push({ id: t.id, data: getJSONData(t) });
                });
                document.querySelectorAll("#holidayWeeks .holidayWeek").forEach(t => {
                    json.holidayWeeks.push({ id: t.id, data: getJSONData(t) });
                });
                document.querySelectorAll("#requirements .taskbrief").forEach(t => {
                    json.requirements.push({ id: t.id, data: getJSONData(t) });
                });
                document.querySelectorAll("#mslist tbody tr.msrequirements").forEach(ms => {
                    var last = json.burndown.push({ id: ms.id }) - 1;
                    var milestone = json.burndown[last];
                    statuses.forEach(status => {
                        milestone[status] = [];
                        ms.querySelectorAll("." + status + " .taskbrief").forEach(task => {
                            milestone[status].push({ id: task.id, data: getJSONData(task)});
                        })
                    });
                });
                return json;
            }
        }
    }
    var graph = {
        init: function() {
            document.querySelector("#graphsScreen #milestone").addEventListener("click", this.milestoneInitgraph);
            document.querySelector("#graphsScreen #project").addEventListener("click", this.projectInitgraph);
            document.querySelector("#graphsScreen #details").addEventListener("click", this.detailsInitgraph);
            document.querySelector("#graphs").setAttribute("data-Init", "graph.refresh");
        },
        refresh: () => document.querySelector("#graphsScreen .graphType-selected").click(),
        setGraph: function(selected) {
            var previous = document.querySelector("#graphsScreen .graphType-selected");
            previous.classList.remove("graphType-selected");
            document.querySelector("#graphsScreen " + selected).classList.add("graphType-selected");
        },
        selectedMS: function() {
            var milestones = project.milestones.getAll();
            if (milestones.length == 0) return;
            var ms = milestones[0];
            if (document.querySelector("#selectMS").selectedOptions.length) {
                var selectedMS = document.querySelector("#selectMS").selectedOptions[0].value;
                ms = [...milestones].filter(m => m.id == selectedMS)[0];
            }
            else {
                var msSelect = document.querySelector("#selectMS");
                milestones.forEach(m => {
                    var data = project.milestones.get(m).data();
                    var option = document.createElement("option");
                    option.value = m.id;
                    option.innerText = data.name;
                    msSelect.appendChild(option);
                });
            }
            document.querySelector("#msChoice").style.display = "";
            return ms;
        },
        milestoneInitgraph: function() {
            graph.setGraph("#milestone");
            var ms = graph.selectedMS();
            if (!ms) return;
            var margin = {top: 20, right: 20, bottom: 30, left: 40},
                width = "50%",
                height = 500;
            
            // Set up left and right screen halves
            var board = d3.select("#graph")
                .html("")
                .append("div")
                .style("width", '100%')
                .style("height", '100%');
            // Select MS dropdown
            board.select("#selectMS")
                .selectAll("milestones")
                .data(project.milestones.getDev())
                .enter()
                .append("option")
                .text(d => project.milestones.get(d).data().name)
                .attr("value", d => project.milestones.get(d).id);
            d3.select('#selectMS').property('value', ms.id);
            var leftGraph = board.append("div")
                .attr("id", "leftGraph")
                .style("width", "50%")
                .style("height", "100%")
                .style("float", "left");
            var rightGraph = board.append("div")
                .attr("id", "rightGraph")
                .style("margin-left", "50%")
                .style("height", "100%");
            d3.select("#selectMS").on("change", function(d) {
                var ms = d3.select(this).property("value");
                document.getElementById("leftGraph").textContent = '';
                document.getElementById("rightGraph").textContent = '';
                drawGraphs();
            });

            function drawGraphs() {
                var msid = d3.select("#selectMS").property("value");
                var ms = document.querySelector("#" + msid.replace(/\./, "\\."));
                if (!ms.classList.contains("development")) return;
                var capacity = project.milestones.get(ms).capacity();
                var tasks =  project.milestones.get(ms).tasks();
                var total = project.milestones.get(ms).burndown();
                var target = project.milestones.get(ms).targetBurndown();
                var width = 600;
                var height = 600;

                // Sum of effort in all reqts on day 1
                var burndown = [];
                if (total.length) burndown.push ({
                    week: "Start",
                    total: total.length ? total[0].effort : 0,
                    target: project.milestones.get(ms).capacity()
                });
                var today = (new Date()).toISOString().slice(0, 10).replace(/-/g, "");
                project.milestones.get(ms).trackingDates().forEach(d => {
                    var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                    var week = d.toDateString().split(" ")[1] + " " + d.getDate();
                    var totalValue = +dt.substr(3) <= +today ?
                        total.filter(t => t.date == dt)[0].effort : 0;
                    var targetValue = target.filter(t => t.date == dt)[0].effort;
                    burndown.push({ week: week, total: totalValue, target: targetValue });
                });

                var maxremainder = burndown.length == 0 ? 0
                    : burndown.map(b => b.total).reduce((a, b) => a > b ? a : b);
                var ymax = Math.max(capacity, maxremainder);

                var xScale = d3.scaleBand()
                    .rangeRound([0, width])
                    .padding(0.2)
                    .domain(burndown.map(b => b.week));
                var yScale = d3.scaleLinear()
                    .rangeRound([height, 0])
                    .domain([0, ymax + 10]);

                var svg = leftGraph.append("svg")
                    .attr("width", "100%")
                    .attr("height", height + margin.top + margin.bottom);
                // Tooltip
                var div = leftGraph.append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);
                // Chart title
                svg.append("text")
                    .attr("x", (width / 2))
                    .attr("y", margin.top)
                    .attr("text-anchor", "middle")
                    .style("font-size", "20px")
                    .style("text-decoration", "underline")
                    .text("Milestone Burndown");
                var g = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                // height of axis-x from bottom of graph
                g.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale));
                // axis-y
                g.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(yScale));
                var bar = g.selectAll("rect")
                    .data(burndown)
                    .enter().append("g");

                // Bars
                bar.append("rect")
                    .attr("x", d => xScale(d.week))
                    .attr("y", d => yScale(d.total))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => height - yScale(d.total))
                    .attr("class", "plainbar bar1")
                    .on("click", function(event, d) {
                        document.querySelector("#schedule").click();
                        msId = document.querySelector("#selectMS").value.replace(/\./, "\\.");
                        editMileStone(document.querySelector("#projectScheduleEditor div#" + msId + ".scheduleMS"));
                    });
                // labels on the bar chart
                bar.append("text")
                    .attr("dy", "1.3em")
                    .attr("x", d => xScale(d.week) + xScale.bandwidth() / 2)
                    .attr("y", d => yScale(d.total) - 20)
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "black")
                    .text(d => d.total > 0 ? d.total : '');
                // line charts
                var stretch = burndown.length == 0 ? 0
                    : 0.1 * burndown[0].target;
                var greenline = d3.line()
                    .x((d, i) => xScale(d.week) + xScale.bandwidth() / 2)
                    .y(d => yScale(d.target));
                bar.append("path")
                    .attr("class", "greenline")
                    .attr("d", greenline(burndown));
                bar.append("circle")
                    .attr("class", "greendot")
                    .attr("cx", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
                    .attr("cy", d => yScale(d.target))
                    .attr("r", 3)
                    .on("mouseover", function(event, d) {
                        div.transition().duration(200).style("opacity", .9);
                        div.html("Week: " + d.week + "<br/>Capacity: " + Math.floor(d.target))
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 10) + "px");
                    })
                    .on("mouseout", function(d) {
                        div.transition().duration(500).style("opacity", 0);
                    });
                bar.append("text")
                    .attr("dx", "1.3em")
                    .attr("dy", "0.5em")
                    .attr("x", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
                    .attr("y", d => yScale(d.target))
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "black")
                    .text(d => d.target > 0 ? Math.floor(d.target) : '');

                var redline = d3.line()
                    .x((d, i) => xScale(d.week) + xScale.bandwidth() / 2)
                    .y(d => yScale(d.target + stretch));
                bar.append("path")
                    .attr("class", "redline")
                    .attr("d", redline(burndown));
                bar.append("circle")
                    .attr("class", "reddot")
                    .attr("cx", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
                    .attr("cy", d => yScale(d.target + stretch))
                    .attr("r", 3)
                    .on("mouseover", function(event, d) {
                        div.transition().duration(200).style("opacity", .9);
                        div.html("Week: " + d.week + "<br/>Stretch: " + Math.floor(d.target + stretch))
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        div.transition().duration(500).style("opacity", 0);
                    });
                bar.append("text")
                    .attr("dx", "1.3em")
                    .attr("dy", "0.5em")
                    .attr("x", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
                    .attr("y", d => yScale(d.target + stretch))
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "black")
                    .text(d => Math.floor(d.target + stretch));

        //--------------------------------------------------------------------------------------------
                var milestone = project.milestones.get(ms);
                var capacity = milestone.capacityConfig();
                var workingDays = milestone.workingDays().length;
                var scope = project.milestones.get(ms).tasks();
                var today = new Date();
                var capacity = milestone.capacityConfig(today);
                var data = capacity.map(c => {
                    if (today > project.milestones.get(ms).endDate()) {
                        remainingDays = 0;
                    }
                    else {
                        capacity.filter(d => d.developer == c.developer)[0];
                        if (today <= project.milestones.get(ms).startDate())
                            remainingDays = milestone.developerCapacity(c.id);
                        remainingDays = milestone.developerCapacity(c.id, today);
                    }
                    return {
                        "Developer": c.developer,
                        "Planned availability": workingDays * parseInt(c.availability) / 100 - c.vacation,
                        "Assigned work": (project.team.getDeveloper(c.id).getTasksForMS(milestone.id)
                            .map(t => project.tasks.get(t.id).getMSBurndown(milestone)[0].effort)
                            .reduce((pr, cv) => { return pr + cv }, 0)).toFixed(2),
                        "Remaining days": remainingDays.toFixed(2),
                        "Remaining work": (project.team.getDeveloper(c.id).getTasksForMS(milestone.id)
                            .map(t => project.tasks.get(t.id).getMSBurndown(milestone)
                                [project.tasks.get(t.id).getMSBurndown(milestone).length - 1].effort)
                            .reduce((pr, cv) => { return pr + cv }, 0)).toFixed(2)
                    }
                });
                data.columns = data.length == 0 ? [ "Not set" ]
                    : Object.keys(data[0]);
                data.y = "Days";

                keys = data.columns.slice(1);
                groupKey = data.columns[0];

                xAxis = g => g
                    .attr("transform", `translate(0,${height + margin.bottom -10})`)
                    .call(d3.axisBottom(x0).tickSizeOuter(0));
                yAxis = g => g
                    .attr("transform", `translate(${margin.left},0)`)
                    .call(d3.axisLeft(y).ticks(null, "s"))
                    .call(g => g.select(".tick:last-of-type text").clone()
                        .attr("x", 3)
                        .attr("text-anchor", "start")
                        .attr("font-weight", "bold")
                        .text(data.y));

                color = d3.scaleOrdinal()
                    .range(["#6b486b", "#a05d56", "#d0743c", "#ff8c00", "#98abc5", "#8a89a6", "#7b6888"]);

                x0 = d3.scaleBand()
                    .domain(data.map(d => d[groupKey]))
                    .rangeRound([margin.left, width - margin.right])
                    .paddingInner(0.1);

                x1 = d3.scaleBand()
                    .domain(keys)
                    .rangeRound([0, x0.bandwidth()])
                    .padding(0.05);

                y = d3.scaleLinear()
                    .rangeRound([height + margin.bottom - 10, margin.top])
                    .domain([0, d3.max(data, d => d3.max(keys, key => d[key])) + 10]).nice();

                legend = svg => {
                    const g = svg
                        .attr("transform", `translate(${width},0)`)
                        .attr("text-anchor", "end")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", 10)
                        .selectAll("g")
                        .data(color.domain().slice().reverse())
                        .join("g")
                        .attr("transform", (d, i) => `translate(0,${i * 20})`);

                    g.append("rect")
                        .attr("x", -19)
                        .attr("width", 19)
                        .attr("height", 19)
                        .attr("fill", color);

                    g.append("text")
                        .attr("x", -24)
                        .attr("y", 9.5)
                        .attr("dy", "0.35em")
                        .text(d => d);
                }

                svg = rightGraph.append("svg")
                    .attr("width", "100%")
                    .attr("height", height + margin.top + margin.bottom);
                div = rightGraph.append("div")
                    .attr("class", "tooltip devburndown")
                    .style("opacity", 0);
                // Chart title
                svg.append("text")
                    .attr("x", (width / 2))
                    .attr("y", margin.top)
                    .attr("text-anchor", "middle")
                    .style("font-size", "20px")
                    .style("text-decoration", "underline")
                    .text("Developer Load");
                g = svg.append("g") // Whole graph boundary
                    .attr("transform", "translate(" + margin.left + ", 0)");

                bar = g.selectAll("rect")
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("transform", d => `translate(${x0(d[groupKey])},0)`)

                // Add bars
                bar.selectAll("rect")
                    .data(d => keys.map(key => ({
                        key,
                        value: d[key]
                    })))
                    .enter()
                    .append("rect")
                    .attr("x", d => x1(d.key))
                    .attr("y", d => y(d.value))
                    .attr("width", x1.bandwidth())
                    .attr("height", d => y(0) - y(d.value))
                    .attr("fill", d => color(d.key))
                    .on("mouseover", function(event, d) {
                        div.transition().duration(200).style("opacity", .9);
                        div.html(d.key + ": " + d.value + " days")
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 32) + "px");
                    })
                    .on("mouseout", function(d) {
                        div.transition().duration(500).style("opacity", 0);
                    })
                    .on("click", function(event, d) {
                        document.querySelector("#schedule").click();
                        msId = document.querySelector("#selectMS").value.replace(/\./, "\\.");
                        editMileStone(document.querySelector("#projectScheduleEditor div#" + msId + ".scheduleMS"));
                    })

                bar.selectAll("text")
                    .data(d => keys.map(key => ({
                        key,
                        value: d[key]
                    })))
                    .enter()
                    .append("text")
                    .attr("dx", "1.4em")
                    .attr("dy", "-0.3em")
                    .attr("x", d => x1(d.key))
                    .attr("y", d => y(d.value))
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "black")
                    .text(d => d.value);

                g.append("g")
                    .call(xAxis);

                g.append("g")
                    .call(yAxis);

                g.append("g")
                    .call(legend);
            }
            drawGraphs();
        },
        projectInitgraph: function() {
            document.querySelector("#msChoice").style.display = "none";
            graph.setGraph("#project");
            var ms = project.milestones.getAll()[0];
            if (!ms) return;
            if (project.tasks.getAll().length == 0) return;
            var projectBurndown = project.burndown.get();
            var targetBurndown = project.burndown.getTarget();
            var today = (new Date()).toISOString().slice(0, 10).replace(/-/g, "");
            var trackingDates = project.dates.trackingDates();
            var burndown = trackingDates.map(d => {
                var dt = d.toDateString().split(" ");
                var dtIndex = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                var efforts = projectBurndown.filter(d => d.date == dtIndex && +dtIndex.substr(3) <= +today);
                return {
                    date: dt[1] + " " + dt[2],
                    effort: efforts.length ? efforts[0].effort : 0,
                    target: targetBurndown.filter(d => d.date == dtIndex)[0].effort
                }
            });
            if (targetBurndown.length) burndown.unshift({
                date: "Start",
                effort: project.tasks.getAll().map(t => project.tasks.get(t.id).getEstimate()).reduce((a, b) => a + b),
                target: targetBurndown[0].effort
            })
            
            var ymax = burndown.length == 0 ? { effort: 0, target: 0 } :
                burndown.reduce((a,b) => Math.max(a.effort, a.target) > Math.max(b.effort, b.target) ? a : b);
            ymax = ymax.effort > ymax.target ? ymax.effort : ymax.target;
            
            var margin = {top: 20, right: 20, bottom: 50, left: 40},
                width = 900,
                height = 600;
            
            var board = d3.select("#graph")
                .html("")
                .append("div")
                .style("width", '100%')
                .style("height", 500);
            
            var xScale = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.2)
                .domain(burndown.map(b => b.date));
            var yScale = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, ymax + 10]);
            
            var svg = board.append("svg")
                .attr("width", "100%")
                .attr("height", height + margin.top + margin.bottom);
            // Tooltip
            var div = board.append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
            
            // Chart title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", margin.top)
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .style("text-decoration", "underline")
                .text("Project Burndown");
            
            var g = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            // height of axis-x from bottom of graph
            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-1.0em")
                .attr("dy", "-.5em")
                .attr("transform", "rotate(-90)");
            // axis-y
            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(yScale));
            
            var bar = g.selectAll("rect")
                .data(burndown)
                .enter().append("g");

            // Bars
            bar.append("rect")
                .attr("x", function(d) { return xScale(d.date); })
                .attr("y", function(d) { return yScale(d.effort); })
                .attr("width", xScale.bandwidth())
                .attr("height", function(d) { return height - yScale(d.effort); })
                .attr("class", "plainbar bar1")
                .on("mouseover", function(event,d) {
                    div.transition().duration(200).style("opacity", .9);
                    div.html("Week: " + d.date + "<br/>Capacity: " + Math.floor(d.target))
                        .style("left", (event.pageX) + "px")
                        .style("top", (event.pageY - 50) + "px");
                })
                .on("mouseout", function(d) {
                    div.transition().duration(500).style("opacity", 0);
                })
                .on("click", function (event) {
                    document.querySelector("#schedule").click();
                    msId = document.querySelector("#selectMS").value.replace(/\./, "\\.");
                    showMilestones();
                });
            // labels on top of the bar
            bar.append("text")
                .attr("dy", "1.3em")
                .attr("x", function(d) { return xScale(d.date) + xScale.bandwidth() / 2; })
                .attr("y", function(d) { return yScale(d.effort) - 17; })
                .attr("text-anchor", "middle")
                .attr("font-family", "sans-serif")
                .attr("font-size", "11px")
                .attr("fill", "black")
                .text(function(d) { return d.effort > 0 ? d.effort : ''; });
            
            // Ideal burndown line
            var greenline = d3.line()
                .x(function(d, i) { return xScale(d.date) + xScale.bandwidth() / 2; })
                .y(function(d) { return yScale(d.target); });
            bar.append("path")
                .attr("class", "greenline")
                .attr("d", greenline(burndown));
            bar.append("circle")
                .attr("class", "greendot")
                .attr("cx", function(d, i) { return xScale(d.date) + xScale.bandwidth() / 2; })
                .attr("cy", function(d) { return yScale(d.target); })
                .attr("r", 3);
            bar.append("text")
                .attr("dx", "1.3em")
                .attr("dy", "0.5em")
                .attr("x", function(d, i) { return xScale(d.date) + xScale.bandwidth() / 2; })
                .attr("y", function(d) { return yScale(d.target); })
                .attr("text-anchor", "middle")
                .attr("font-family", "sans-serif")
                .attr("font-size", "11px")
                .attr("fill", "black")
                .text(function(d) { return d.target > 0 ? Math.floor(d.target) : ''; });
        },
        detailsInitgraph: function() {
            graph.setGraph("#details");
            var ms = graph.selectedMS();
            if (!ms) return;
            var margin = {top: 20, right: 20, bottom: 30, left: 40},
            width = 600,
            height = 600;
            
            // Set up left and right screen halves
            var board = d3.select("#graph")
                .html("")
                .append("div")
                .style("width", '100%')
                .style("height", 500);
            d3.select('#selectMS').property('value', ms.id);
            var leftGraph = board.append("div")
                .attr("id", "leftGraph")
                .style("width", "50%")
                .style("height", "100%")
                .style("float", "left");
            var rightGraph = board.append("div")
                .attr("id", "rightGraph")
                .style("margin-left", "50%")
                .style("height", "100%");
            d3.select("#selectMS").on("change", function(d) {
                var ms = d3.select(this).property("value");
                document.getElementById("leftGraph").textContent = '';
                document.getElementById("rightGraph").textContent = '';
                drawGraphs(project, ms);
            });
            
            var xScale, yScale, svg, div, g;
            
            function drawGraphs() {
                var milestones = project.milestones.getDev();
                if (milestones.length == 0) return;
                var today = (new Date()).toISOString().slice(0, 10).replace(/-/g, "");
                var ms = document.querySelector("#selectMS") ?
                    document.querySelector("#selectMS").selectedOptions[0].value
                    : milestones[0].id;
                var milestone = [...milestones].filter(m => m.id == ms)[0];
                var taskData = project.milestones.get(milestone).tasks().map(t => {
                    return {
                        name: project.tasks.get(t.id).data().name,
                        burndown: project.tasks.get(t.id).getMSBurndown(milestone),
                        estimate: project.tasks.get(t.id).getEstimate()
                    }
                });
                var trackingDates = project.milestones.get(milestone).trackingDates();
                var fdata = trackingDates.map(d => {
                    var dtParts = d.toDateString().split(" ");
                    var data = { group: dtParts[1] + " " + dtParts[2] };
                    dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                    taskData.forEach(t => data[t.name] = +dt.substr(3) <= today ?
                        t.burndown.filter(b => b.date == dt)[0].effort : 0);
                    return data;
                });
                var initData = { group: "Start" };
                taskData.forEach(t => initData[t.name] = t.estimate);
                fdata.unshift(initData);
                drawPaper(project, milestone, leftGraph, "Feature Burndown", fdata);

                var trackingDates = project.milestones.get(milestone).trackingDates();
                var startDate = project.milestones.get(milestone).startDate();
                if (startDate) trackingDates.unshift(startDate);
                var msBurndown = project.team.getDevelopers().map(d => {
                    var taskData = project.team.getDeveloper(d).getTasksForMS(milestone.id)
                        .map(t => project.tasks.get(t.id).getMSBurndown(milestone));
                    var developerBurndown = trackingDates.map(d => {
                        var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                        var taskList = taskData.map(r => r.filter(s => s.date == dt)[0].effort);
                        var effort = taskList.length > 0 ? taskList.reduce((a, b) => a + b) : 0;
                        return { date: dt, effort: effort }
                    });
                    return {
                        developer: d,
                        assigned: developerBurndown
                    }
                });
                taskData = project.milestones.get(milestone).unassignedDeveloper()
                    .map(t => project.tasks.get(t.id).getMSBurndown(milestone));
                taskBurndown = trackingDates.map(d => {
                    var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                    var taskList = taskData.map(r => r.filter(s => s.date == dt)[0].effort);
                    var effort = taskList.length > 0 ? taskList.reduce((a, b) => a + b) : 0;
                    return { date: dt, effort: effort }
                });
                msBurndown.push({ developer: "Unassigned", assigned: taskBurndown });
                var udata = trackingDates.map(d => {
                    var dt = "dt_" + (d.toISOString().slice(0,10).replace(/-/g,""));
                    var dtParts = d.toDateString().split(" ");
                    var data = { group: dtParts[1] + " " + dtParts[2] }
                    msBurndown.map(m => m.developer).forEach(developer => {
                        var devname = developer != "Unassigned" ?
                            project.team.getDeveloper(developer).data().name : "Unassigned";
                        data[devname] = msBurndown.filter(m => m.developer == developer)[0]
                            .assigned.filter(a => a.date == dt)[0].effort
                    });
                    return data;
                });
                if (udata.length) udata[0].group = "Start";
                drawPaper(project, milestone, rightGraph, "Developer Burndown", udata);
            }
            
            function drawPaper(project, ms, paper, title, data) {
                var capacity = project.milestones.get(ms).capacity();
                var ymax = project.milestones.get(ms).burndown().map(b => b.effort)
                    .concat(capacity).reduce((a, b) => a > b ?  a : b);
                var workingweeks = project.milestones.get(ms).trackingDates();
                
                var groups = data.map(d => d.group);
                var subgroups = data.length == 0 ? [] :
                    Object.keys(data[0]).filter(k => k != "group");

                var color = d3.scaleOrdinal()
                    .domain(subgroups)
                    .range(['#e41a1c','#377eb8','#4daf4a']);

                xScale = d3.scaleBand()
                    .rangeRound([0, width])
                    .padding(0.2)
                    .domain(groups);
                yScale = d3.scaleLinear()
                    .rangeRound([height, 0])
                    .domain([0, ymax * 1.2]);

                svg = paper.append("svg")
                    .attr("width", "100%")
                    .attr("height", height + margin.top + margin.bottom);
                // Tooltip
                tooltip = paper.append("div")
                    .attr("class", "tooltip")
                    .style("width", 250)
                    .style("opacity", 0);
                // Chart title
                svg.append("text")
                    .attr("x", (width / 2))
                    .attr("y", margin.top)
                    .attr("text-anchor", "middle")
                    .style("font-size", "20px")
                    .style("text-decoration", "underline")
                    .text(title);
                g = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                // height of axis-x from bottom of graph
                g.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale));
                // axis-y
                g.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(yScale));
                // Legend
                var legend = g.append("g")
                    .attr("transform", `translate(${width},0)`)
                    .attr("text-anchor", "end")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("g")
                    .data(color.domain().slice())
                    .join("g")
                    .attr("transform", (d, i) => {
                        return `translate(0,${i * 20})`;
                    });
                    
                legend.append("rect")
                    .attr("x", -19)
                    .attr("width", 19)
                    .attr("height", 19)
                    .attr("fill", color);

                legend.append("text")
                    .attr("x", -24)
                    .attr("y", 9.5)
                    .attr("dy", "0.35em")
                    .text(d => d);
                
                var stackedData = d3.stack()
                    .keys(subgroups)
                    (data)

                // Show the bars
                var bar = g.append("g")
                    .selectAll("g")
                    // Enter in the stack data = loop key per key = group per group
                    .data(stackedData)
                    .enter()
                        .append("g")
                        .attr("fill", d => color(d.key))
                    
                var bar_enter = bar.selectAll("rect")
                    .data(d => d)
                    .enter()
                        .append("rect")
                        .attr("x", d => xScale(d.data.group))
                        .attr("y", d => yScale(d[1]))
                        .attr("height", d => yScale(d[0]) - yScale(d[1]))
                        .attr("width",xScale.bandwidth())
                        .on("mouseover", function(event, d) {
                            var key = d3.select(this.parentNode).datum().key;
                            var remaining = d.data[key];
                            tooltip.transition().duration(200).style("opacity", .9);
                            var tip = "<b>" + title.split(" ")[0] + ":</b> "  + key + "<br><b>Remaining:</b> " + remaining + " days";
                            tooltip.html(tip)
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 8) + "px");
                        })
                        .on("mouseout", function(d) {
                            tooltip.transition().duration(500).style("opacity", 0);
                            // enter a second time = loop subgroup per subgroup to add all rectangles
                        })
                        .on("click", function(d) {
                            document.querySelector("#schedule").click();
                            msId = document.querySelector("#selectMS").value.replace(/\./, "\\.");
                            editMileStone(document.querySelector("#projectScheduleEditor div#" + msId + ".scheduleMS"));
                        })
            }
            drawGraphs(project, ms);
        }
    };
    var form = {
        edit: function (event) {
            var item = event.target.closest(".item");
            var id = item.id;
            var data = item.querySelector("#data");
            var itemClass = id.split('.')[0];
            console.log("Edit [" + itemClass + "], id:", id);
            this["ui"] = document.querySelector("#" + itemClass + "Form");
            callFuntion("initForm_" + itemClass, [this.ui, id]);
            var data = getJSONData(item);
            Object.keys(data).forEach(feildname => {
                var input = this.ui.querySelector("#" + feildname.replace(/\./, "\\."));
                if (!input) return;
                if (["text", "textarea", "date", "week"].filter(t => t == input.type).length)
                    input.value = data[feildname];
                if (input.type == "radio")
                    if (data[feildname])
                        input.checked = true;
                    else
                        input.checked = false;
            });
            this.ui.style.display = 'block';
            var burnEditor = this.ui.querySelector("#editBurndown");
            if (burnEditor) burnEditor.onclick = function (e) {
                this.ui.style.display = "none";
                editBurndown(event);
            }
            this.ui.querySelector('#yes').onclick = function (event) {
                ui = this.closest(".modal");
                document.querySelectorAll("#" + id.replace(/\./, "\\.")).forEach(i => {
                    form.saveData(i, ui);
                    callFuntion("onedit_" + itemClass, i);
                });
                form.clearData(ui);
            };
            this.ui.querySelector('#no').onclick = function (event) {
                this.closest(".modal").style.display = 'none';
            };
        },
        clearData: function (ui) {
            ui.querySelectorAll("input").forEach(f => {
                if (f.type == "text" || f.type == "date" || f.type == "week")
                    f.value = '';
            });
            ui.querySelectorAll("textarea").forEach(t => t.value = '');
        },
        saveData: function (item, ui) {
            returnData = {};
            var data = getJSONData(item);
            Object.keys(data).forEach(f => returnData[f] = data[f]);
            ui.querySelectorAll("input").forEach(f => {
                var value;
                if (f.type == "radio") {
                    value = f.checked;
                }
                if (f.type == "text" || f.type == "date" || f.type == "week")  {
                    value = f.value;
                }
                returnData[f.id] = value;
            });
            ui.querySelectorAll("textarea").forEach(t => returnData[t.id] = t.value);
            if (data = item.querySelector("#data")) data.innerText = JSON.stringify(returnData);
            if (returnData.name.length && item.querySelector(".itemName"))
                item.querySelector(".itemName").innerText = returnData.name;
            ui.style.display = 'none';
        },
        initData: function(formSelector, params) {
            var data = params.querySelector("#data");
            var form = document.querySelector(formSelector);
            var returnData = {};
            form.querySelectorAll("input").forEach(f => {
                returnData[f.id] = "";
                f.value = "";
            });
            returnData["name"] = params.querySelector(".itemName").innerText;
            returnData[defaults.size] = true;
            data.innerText = JSON.stringify(returnData);
            params.querySelector(".itemName").innerText = returnData.name;
        }
    }

    document.querySelector("body").onload = function() {
        document.querySelector(".topmenu").classList.add("topmenu-selected");
        document.querySelectorAll(".topmenu").forEach(screen => {
            screen.addEventListener("click", e => {
                var selected = document.querySelector(".topmenu-selected");
                selected.classList.remove("topmenu-selected");
                document.querySelector("#" + selected.id + "Screen").style.display = "none";
                var target = e.target.closest(".topmenu");
                target.classList.add("topmenu-selected");
                document.querySelector("#" + target.id + "Screen").style.display = "";
                var initFunction = target.getAttribute("data-init");
                if (!initFunction) initFunction = target.id + "Init";
                callFuntion(initFunction);
            })
        });
        document.querySelector("#loadfile").addEventListener("click", project.file.open);
        document.querySelector("#savefile").addEventListener("click", project.file.save);
        graph.init();
        // Defaults
        document.querySelectorAll("input.default").forEach(d => {
            d.value = eval(d.getAttribute("data-path"));
        });
        document.querySelectorAll("div#estimate").forEach(d => {
            var estimate = document.getElementById("estimateTemplate");
            d.appendChild(estimate.content.cloneNode(true));
        });
        document.querySelectorAll("div#priorities input").forEach(d => {
            var label = d.parentNode.querySelector("label#" + d.id);
            var priority = document.createElement("option");
            priority.id = d.id;
            priority.innerText = label.innerText;
            priority.selected = d.checked;
            document.querySelector("select#priority").appendChild(priority);
        });
        document.querySelectorAll("div#roles input").forEach(d => {
            var label = d.parentNode.querySelector("label#" + d.id);
            var role = document.createElement("option");
            role.id = d.id;
            role.innerText = label.innerText;
            role.selected = d.checked;
            document.querySelector("select#role").appendChild(role);
        });
        document.querySelectorAll("#week .weekday").forEach(d => {
            var value = +d.getAttribute("data-value");
            if (defaults.burndownDays.includes(value) || defaults.weeklyHolidays.includes(value)) {
                var daytype = defaults.burndownDays.includes(value) ? "workday" : "holiday";
                dragdrop.dragged = document.querySelector("img#" + daytype);
                dragdrop.add('dayOfWeek', d);
            }
        })
        document.querySelector("#estimateTemplate").content.querySelectorAll("input").forEach(d => {
            var label = d.parentNode.querySelector("label#" + d.id);
            var estimate = document.createElement("option");
            estimate.id = d.id;
            estimate.innerText = label.innerText;
            estimate.selected = d.checked;
            document.querySelector("select#size").appendChild(estimate);
        });
        // Drag and drop handlers
        document.addEventListener("dragstart", (event) => dragdrop.dragstart(event), false);
        document.addEventListener("dragover", (event) => event.preventDefault(), false);
        document.addEventListener("drop", function(event) {
            event.preventDefault();
            dragdrop.drop(event);
            dragdrop.dragged = '';
        }, false);
    }
    function callFuntion(functionName, params) {
        if (functionName.split(".").length == 1) {
            var argType = typeof window[functionName];
            console.log("Calling function named", functionName, "type:", argType);
            if (argType === "function") window[functionName](params);
        }
        else {
            params = window;
            var args = Array.prototype.slice.call(arguments, 2);
            var namespaces = functionName.split(".");
            var func = namespaces.pop();
            for(var i = 0; i < namespaces.length; i++) {
                params = params[namespaces[i]];
            }
            return params[func].apply(params, args);
        }
    }
    function editBurndown(event) {
        var bdForm = document.querySelector("#burndownForm");
        var startDate = document.querySelector("#projectInfo #startDate").value;
        if (startDate == '') return burnDownEditError(bdForm, "Start date for project not set.");
        var item = event.target.closest(".item");
        var id = item.id;
        var data = getJSONData(item);
        if (event.target.closest("table").id == "mslist")
            milestone = event.target.closest("tr");
        if (event.target.closest("table").id == "devtasklist")
            milestone = document.querySelector("#milestoneEditor .scheduleMS");
        bdForm.style.display = 'block';
        bdForm.querySelector("#taskbrief").innerHTML = data.name;
        bdForm.querySelector("#estimate").innerHTML = project.tasks.get(id).getSize() + " ("
            + project.tasks.get(id).getEstimate() + ")";
        bdForm.querySelector(".milestones").id = milestone.id;
        bdForm.querySelector(".milestones").innerHTML = project.milestones.get(milestone).data().name;
        var mserrors = [];
        if (mserrors.length)
            return burnDownEditError(bdForm, "Set Milestone lengths:<br/>" + mserrors.join("<br/>"));
        showBurndown(item, bdForm);
        bdForm.querySelector("#editTask").onclick = function (e) {
            bdForm.edit(event);
            bdForm.style.display = "none";
        }
        bdForm.querySelector("#yes").onclick = function (event) {
            document.querySelectorAll("#" + id.replace(/\./, "\\.")).forEach(i => form.saveData(i));
            bdForm.clearData(bdForm);
            document.querySelector(".graphType-selected").click();
        };
        bdForm.querySelector("#no").onclick = function (event) {
            bdForm.style.display = 'none';
        };
    }
    function showDeveloperVeiw() {
        document.querySelector("#milestoneEditor #tester").classList.remove("selected");
        document.querySelector("#milestoneEditor #developer").classList.add("selected");
        document.querySelector("#milestoneEditor tbody#developer").style.display = "";
        document.querySelector("#milestoneEditor tbody#tester").style.display = "none";
        document.querySelector("#milestoneEditor #msbacklog").style.display = "";
        document.querySelector("#milestoneEditor #qabacklog").style.display = "none";
    }
    function scheduleInit() {
        var today = new Date();
        document.querySelectorAll("#mslist tbody tr").forEach(r => {
            var ms = project.milestones.get(r);
            var age = ms.endDate() < today ? r.style.backgroundColor = "#eeeeee" :
                ms.startDate() > today ? r.style.backgroundColor = "#eeeeff" :
                r.style.backgroundColor = "#ffffff";
        });
    }
    function showTesterView() {
        document.querySelector("#milestoneEditor #developer").classList.remove("selected");
        document.querySelector("#milestoneEditor #tester").classList.add("selected");
        document.querySelector("#milestoneEditor tbody#developer").style.display = "none";
        document.querySelector("#milestoneEditor tbody#tester").style.display = "";
        document.querySelector("#milestoneEditor #msbacklog").style.display = "none";
        document.querySelector("#milestoneEditor #qabacklog").style.display = "";
    }
    function showBurndown(requirement, form) {
        var id = form.querySelector(".milestones").id;
        var msid = document.querySelector(".milestones#" + id.replace(/\./, "\\."));
        var msStartDate = project.milestones.get(msid).startDate();
        var msWeeks = +project.milestones.get(msid).dataValue("weeks");
        var msEndDate = project.milestones.get(msid).endDate();
        document.querySelector("#daterange").innerText = msStartDate
            .toLocaleString("default", { month: "short", day: "numeric"}) + " - "
            + msEndDate.toLocaleString("default", { month: "short", day: "numeric", year: "numeric" });
        var weeks = project.milestones.get(msid).dataValue("weeks");
        var tbody = document.querySelector("#burndownForm table tbody");
        tbody.innerHTML = "";
        var data = getJSONData(requirement);
        for(var week = 0, msdate = project.milestones.get(msid).startDate(); week < weeks; week++) {
            var tr = document.createElement("tr");
            for(var d = 0; d < 7; d++) {
                var td = document.createElement("td");
                td.innerText = msdate.getDate();
                msdate.setDate(msdate.getDate() + 1);
                tr.appendChild(td);
            }
            for(var d = 0; d < project.dates.burndownDays().length; d++) {
                var day = project.dates.burndownDays()[d];
                var bdDate = new Date(msStartDate);
                bdDate.setDate(bdDate.getDate() + (week * 7) + day - 1);
                var id = "dt_" + (bdDate.toISOString().slice(0,10).replace(/-/g,""));
                input = '<input id="' + id + '" class="bdData">';
                tr.querySelector(":nth-child(" + day + ")").innerHTML += input;
                if (Object.keys(data).filter(key => key == id).length > 0)
                   tr.querySelector(":nth-child(" + day + ") input").value = data[id];
            }
            tbody.appendChild(tr);
        }
    }
    function burnDownEditError(form, message) {
        form.querySelector(".form").style.display = "none";
        form.querySelector(".message").style.display = "";
        form.querySelector(".message p").innerHTML = message;
        form.querySelector("#exit").onclick = function (event) {
            form.style.display = 'none';
            form.querySelector(".form").style.display = "";
            form.querySelector(".message").style.display = "none";
        };
        form.style.display = 'block';
    }
    function deleteItem(event) {
        var id = event.target.closest(".item").id;
        var selector = '#' + id.split('.')[0] + '\\.' + id.split('.')[1];
        var element = document.querySelector(selector);
        var parent = element.parentElement;
        var confirm = document.querySelector("#confirmDelete");
        var deleted = confirm.querySelector('#message').appendChild(element.cloneNode(true));
        confirm.style.display = 'block';
        confirm.querySelector('#yes').onclick = function (event) {
            document.querySelectorAll(selector).forEach(n => n.remove());
            confirm.style.display = 'none';
        };
        confirm.querySelector('#no').onclick = function (event) {
            confirm.querySelector('#message').removeChild(deleted);
            confirm.style.display = 'none';
        };
    }
    function showBacklog() {
        document.querySelector("#scheduleScreen #backlogsummary").style.display = "none";
        document.querySelector("#scheduleScreen #backlog").style.display = "";
    }
    function hideBacklog() {
        document.querySelector("#scheduleScreen #backlogsummary").style.display = "";
        document.querySelector("#scheduleScreen #backlog").style.display = "none";
    }
    function getJSONData(node) {
        var data = {};
        try {
            data = JSON.parse(node.querySelector("#data").innerText);
        }
        catch (c) {
            console.log("Could not parse JSON inside #data of", node);
        }
        return data;
    }
    function assignTask(task, cell, role) { // "role" is "developer" or "tester" or ""
        // Set the name of the developer of the task
        var data = getJSONData(task);
        var assignee = "";
        var closestTable = cell.closest("table");
        if (closestTable.id == "mslist") {
            assignee = data[role];
            if (assignee && assignee.length > 0) assignee = assignee[0][assignee];
        }
        if (closestTable.id == "devtasklist") {
            assignee = cell.closest("tr").querySelector("td div").id;
        }
        if (closestTable.id == "msbacklog" || closestTable.id == "qabacklog") {
            assignee = "";
        }
        data[role] = assignee;
        return data;
    }
    function editMileStone(milestone) {
        // Hide the Project scedule editor (table of milestones)
        document.querySelector("#projectScheduleEditor").style.display = "none";
        var mseditor = document.querySelector("#milestoneEditor");
        // Clear the previous MS editing session
        document.querySelector("#msicon").innerHTML = '';
        mseditor.querySelector("tbody#developer").innerHTML = '';
        mseditor.querySelector("tbody#tester").innerHTML = '';
        mseditor.querySelector("#msbacklog tbody").innerHTML = '';
        mseditor.querySelector("#qabacklog tbody").innerHTML = '';
        // Put header icon on top
        document.querySelector("#msicon").appendChild(milestone.closest(".scheduleMS").cloneNode(true));
        // Set up start and end dates in header
        var ms = project.milestones.get(milestone);
        var dateRange = ms.startDate().toDateString() + " - "
            + ms.endDate().toDateString();
        document.querySelector("#milestoneEditor #header").innerText = dateRange;
        // For each team member, create a row in developer or tester table
        document.querySelectorAll('#teamDiv #team .teamMember').forEach(dev => {
            var msrow = document.querySelector("#msTemplate").content.cloneNode(true);
            msrow.querySelector(".msicon").innerHTML = "";
            var devwidget = dev.closest(".teamMember").cloneNode(true);
            devwidget.classList.add("undraggable");
            var controls = devwidget.querySelector(".controls");
            controls.parentElement.removeChild(controls);
            msrow.querySelector(".msicon").appendChild(devwidget);
            var role = dev.classList.contains("developer") ? "developer" : "tester";
            mseditor.querySelector("tbody#" + role).appendChild(msrow);
        });
        // List tasks at end: for all columns in milestone row
        var msrequirements = milestone.closest("tr").cloneNode(true);
        var qarequirements = milestone.closest("tr").cloneNode(true);
        msrequirements.id = "unassigned";
        document.querySelector("#msbacklog tbody").appendChild(msrequirements);
        document.querySelector("#qabacklog tbody").appendChild(qarequirements);
        // Clear contents of first cell with MS icon
        msrequirements.querySelector("td").innerText = "";
        qarequirements.querySelector("td").innerText = "";
        // Copy cell widths
        var columns = document.querySelectorAll("#devtasklist tr th");
        var ncolumns = columns.length;
        for (var i = 0; i < ncolumns; i++) {
            var column = msrequirements.querySelector("tr td:nth-child(" + (i + 1) + ")");
            // column.classList.remove("status");
            if (columns[i].style.width) {
                column.style.width = columns[i].style.width;
            }
            var column = qarequirements.querySelector("tr td:nth-child(" + (i + 1) + ")");
            if (columns[i].style.width) {
                column.style.width = columns[i].style.width;
            }
        }
        // For each task status, move tasks to developer row
        document.querySelectorAll("#msbacklog td:not(.msicon)").forEach(status => {
            // Get the column status to search for the right column in the table above
            var columnStatus = statuses.filter(s => status.classList.contains(s))[0];
            // For each task in status column
            status.querySelectorAll(".taskbrief").forEach(task => {
                task.querySelector(".burndown").onclick = editBurndown;
                task.querySelector(".edit").onclick = form.edit;
                task.querySelector(".delete").onclick = deleteItem;
                var data = getJSONData(task);
                var developer = data.developer;
                if (developer && developer != '') {
                    var devRow = document.querySelector("#devtasklist #" + developer.replace(/\./, "\\."))
                        .closest("tr");
                    devRow.querySelector("." + columnStatus).appendChild(task);
                }
            });
        });
        mseditor.style.display = "";
        document.querySelectorAll("#qabacklog td:not(.msicon)").forEach(status => {
            // Get the column status to search for the right column in the table above
            var columnStatus = statuses.filter(s => status.classList.contains(s))[0];
            // For each task in status column
            status.querySelectorAll(".taskbrief").forEach(task => {
                task.querySelector(".burndown").onclick = editBurndown;
                task.querySelector(".edit").onclick = form.edit;
                task.querySelector(".delete").onclick = deleteItem;
                var data = getJSONData(task);
                var tester = data.tester;
                if (tester && tester != '') {
                    var devRow = document.querySelector("#devtasklist #" + tester.replace(/\./, "\\."))
                        .closest("tr");
                    devRow.querySelector("." + columnStatus).appendChild(task);
                }
            });
        });
    }
    function showMilestones() {
        document.querySelector("#projectScheduleEditor").style.display = "flex";
        document.querySelector("#milestoneEditor").style.display = "none";
    }
    function onadd_backlogitem(params) {
        params.querySelector(".itemName").innerText = dragdrop.dragged.innerText.trim();
        params.classList.remove("backlogitem");
        params.classList.add("newTask");
        params.querySelector(".burndown").onclick = editBurndown;
        params.style.backgroundColor = dragdrop.dragged.style.backgroundColor;
        form.initData("#requirementsForm", params);
        var id = dragdrop.dragged.id;
        var data = getJSONData(params);
        data.reference = id;
        params.querySelector("#data").innerText = JSON.stringify(data);
    }
    function onadd_dayOfWeek(params) {
        var dropzone = params.closest(".weekday");
        dropzone.querySelector(".dayOfWeek").style.display = "inline-block";
        dropzone.querySelector(".dayOfWeek").style.removeProperty("width");
        var edit = dropzone.querySelector(".edit");
        edit.parentNode.removeChild(edit);
        edit = dropzone.querySelector(".itemName");
        edit.parentNode.removeChild(edit);
    }
    function onadd_newTask(params) {
        var role = params.closest("tbody").id;
        var data = getJSONData(params);
        data[defaults.priority] = true;
        data[defaults.size] = true;
        params.querySelector(".burndown").onclick = editBurndown;
        params.querySelector("#data").innerText = JSON.stringify(data);
        var dropTable = params.closest("table");
        if (dropTable.id == "devtasklist") {
            var milestone = params.closest("#milestoneEditor").querySelector(".scheduleMS");
            var msRow = document.querySelector("#scheduleScreen #" + milestone.id.replace(/\./, "\\."));
            var status = [...params.closest("td").classList].filter(f => statuses.filter(s => s == f).length)[0];
            var data = assignTask(params, params.closest("td"), role);
            params.querySelector("#data").innerText = JSON.stringify(data);
            var taskCopy = params.cloneNode(true);
            taskCopy.querySelector(".burndown").onclick = editBurndown;
            taskCopy.querySelector(".edit").onclick = form.edit;
            taskCopy.querySelector(".delete").onclick = deleteItem;
            msRow.querySelector("." + status).appendChild(taskCopy);
        }
    }
    function onadd_scheduleMS(params) {
        var mstype = params.querySelector(".menuIcon").id;
        params.classList.add(mstype);
        var data = getJSONData(params);
        data.type = mstype;
        data.weeks = defaults.sprintLenth;
        params.querySelector("#data").innerText = JSON.stringify(data);
        if (mstype != 'development') return;
        // Add development MS to tracking tab
        var devMilestones = document.querySelector("#mslist #milestones");
        var msnode = params.cloneNode(true);
        msnode.draggable = false;
        msnode.classList.remove("dragable");
        msnode.querySelector("#development").addEventListener("click", function(event) {
            editMileStone(event.target.closest(".scheduleMS"));
        });
        var controls = msnode.querySelector(".controls");
        controls.parentElement.removeChild(controls);
        var msdiv = document.querySelector("#msTemplate").content.cloneNode(true);
        msdiv.querySelector(".msrequirements").id = params.id;
        msdiv.querySelector(".msicon").appendChild(msnode);
        devMilestones.appendChild(msdiv);
    }
    function onadd_teamMember(params) {
        var role = params.querySelector("img").id;
        params.classList.add(role);
        var data = getJSONData(params);
        data.role = role;
        params.querySelector("#data").innerText = JSON.stringify(data);
    }
    function onadd_workItem(params) {
        var requirements = document.querySelector("#scheduleScreen #backlog #list");
        var description = params.querySelector(".itemName").innerText;
        var reqt = document.createElement("div");
        var level = [...dragdrop.dragged.parentElement.classList].filter(c => c.match(/level/))[0];
        reqt.id = params.id;
        reqt.classList.add("reqt");
        reqt.classList.add("backlogitem");
        reqt.style.backgroundColor = params.style.backgroundColor;
        reqt.setAttribute('draggable', true);
        para = document.createElement("p");
        para.innerText = description;
        reqt.appendChild(para);
        var data = getJSONData(params);
        data[defaults.priority] = true;
        data[defaults.size] = true;
        data.level = level;
        data.left = params.style.left;
        data.top = params.style.top;
        params.querySelector("#data").innerText = JSON.stringify(data);
        requirements.appendChild(reqt);
    }
    function onedit_requirements(params) {
        var data = getJSONData(params);
        if (!data.name) return;
        var requirements = document.querySelector("#scheduleScreen #backlog #list");
        var reqt = requirements.querySelector("#" + params.id.replace(/\./, "\\.") + " p");
        reqt.innerText = data.name;
        requirements = document.querySelector("#requirementsScreen #" + params.id.replace(/\./, "\\."));
        requirements.querySelector(".itemName").innerText = data.name;
    }
    function oninsert_milestones(params) {
        onadd_scheduleMS(params);
        var devMSList = devMilestones();
        var scheduledMilestones = document.querySelectorAll("#developer .msrequirements");
        if (devMSList.length != scheduledMilestones.length) console.log("Data in schedule tab out of sync");
        for (i = 0; i < devMSList.length; i++) {
            if (devMSList[i].id != scheduledMilestones[i].id) {
                var correctRow = Array.from(scheduledMilestones).filter(r => r.id == devMSList[i].id);
                console.log("Mismatch in row", i, devMSList[i].id, scheduledMilestones[i].id);
                scheduledMilestones[i].parentNode.insertBefore(scheduledMilestones[i], correctRow[0]);
                scheduledMilestones = document.querySelectorAll("#developer .msrequirements");
            }
        }
    }
    function onmovetoend_scheduleMS(params) {
        console.log("onmovetoend_scheduleMS", params);
        var msno = 0;
        document.querySelectorAll("#scheduleDiv #itemImage #development").forEach(img => {
            var msid1 = img.closest(".scheduleMS").id.replace(/\./, "\\.");
            var tr1 = document.querySelectorAll("#scheduleScreen .mslayout tr.msrequirements")[msno];
            var msid2 = tr1.querySelector(".scheduleMS").id.replace(/\./, "\\.");
            if (msid2 != msid1) {
                tr1 = document.querySelectorAll("#scheduleScreen #" + msid1)[0].closest("tr");
                tr2 = document.querySelectorAll("#scheduleScreen #" + msid2)[0].closest("tr");
                console.log("Exchange", tr1.querySelector(".itemName").innerText, "-", tr2.querySelector(".itemName").innerText)
                var parent = tr1.parentNode;
                parent.insertBefore(tr1, tr2);
            }
            msno++;
        });
    }
    function initForm_milestones(params) {
        var capacitydata = params[0].querySelector(".capacitydata");
        var dates = document.querySelector("#milestonesForm #msdates");
        var ms = [...project.milestones.getAll()].filter(m => m.id == params[1])[0];
        if (ms.classList.contains("development")) {
            mstype = "development";
            staff = [...document.querySelectorAll("#settingsScreen #team #lead")]
                .concat([...document.querySelectorAll("#settingsScreen #team #developer")])
        }
        else {
            mstype = "testing";
            staff = [...document.querySelectorAll("#settingsScreen #team #tester")]
        }

        var startDate = project.milestones.get(ms).startDate();
        if (startDate == null) {
            dates.innerText = "Project start date not set";
        }
        else {
            var endDate = project.milestones.get(ms).endDate();
            dates.innerText = startDate.toLocaleDateString() + " - " + endDate.toLocaleDateString();
        }

        var teamlist = capacitydata.querySelector("#teamlist");
        teamlist.innerHTML = "<td>Name</td>";
        if (mstype == "development") {
            capacity = capacitydata.querySelector("#capacity");
            capacity.innerHTML = "<td>Capacity</td>";
        }
        var vacation = capacitydata.querySelector("#vacation");
        vacation.innerHTML = "<td>Leave</td>";

        capacitydata.closest(".container").querySelector("#weeks").value = defaults.sprintLenth;
        capacitydata.closest(".container").style.width = "500px";
        staff.forEach(developer => {
            var dev = developer.closest(".teamMember").cloneNode(true);
            var td = document.createElement("td");
            var role = developer.id;
            td.innerText = dev.querySelector(".itemName").innerText;
            teamlist.appendChild(td);

            if (mstype == "development") {
                td = document.createElement("td");
                var capacityInput = document.createElement("input");
                capacityInput.id = dev.id;
                capacityInput.value = defaults.capacity[role];
                capacityInput.style.width = "4ch";
                td.appendChild(capacityInput);
                td.appendChild(document.createTextNode("%"));
                capacity.appendChild(td);
            }

            td = document.createElement("td");
            var vacationInput = document.createElement("input");
            vacationInput.id = "vac_" + dev.id;
            vacationInput.value = defaults.capacity.vacation;
            vacationInput.style.width = "4ch";
            td.appendChild(vacationInput);
            td.appendChild(document.createTextNode("days"));
            vacation.appendChild(td);
        })
    }
    function initForm_requirements(params) {
        params[0].querySelector(".container").style.width = "500px";
    }
    function initForm_team(params) {
        var id = params.filter(t => typeof(t) == 'string' && t.match(/^team/))[0];
        var role = project.team.getDeveloper(id).data().role;
        document.querySelector(".formDescription").innerText = "Role: " + role;
    }
</script>